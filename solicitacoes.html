<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Solicitações | Hara Spa</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<style>
body { margin:0; font-family:'Segoe UI'; background:#f5f7fb; }
.app { display:flex; min-height:100vh; }
.content { flex:1; padding:40px; margin-left:260px; }

.card {
  background:#fff;
  border-radius:20px;
  padding:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  margin-bottom:30px;
}

button {
  background:#1f2937;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px 14px;
  cursor:pointer;
  margin-right:10px;
}

button:hover { opacity:.9; }

.btn-danger { background:#dc2626; }

.btn-icon {
  border:none;
  background:none;
  cursor:pointer;
  font-size:18px;
  margin-right:8px;
}

.btn-aprovar { color:#16a34a; }
.btn-reprovar { color:#dc2626; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

th, td {
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:left;
}

.status-pendente { color:#d97706; font-weight:bold; }
.status-aprovado { color:#16a34a; font-weight:bold; }
.status-reprovado { color:#dc2626; font-weight:bold; }
</style>
</head>
<body>

<div class="app">
<aside id="sidebar"></aside>

<main class="content">

<!-- NOVA SOLICITAÇÃO -->
<div class="card">
<h2>Nova Solicitação</h2>

<label>Terapeuta</label>
<select id="terapeuta"></select><br><br>

<label>Tipo</label>
<select id="tipo">
<option>Falta</option>
<option>Férias</option>
<option>Atestado</option>
<option>Viagem</option>
</select><br><br>

<label>Data Início</label>
<input type="date" id="data_inicio"><br><br>

<label>Data Fim</label>
<input type="date" id="data_fim"><br><br>

<label>Justificativa</label>
<input id="justificativa"><br><br>

<button onclick="salvar()">Salvar</button>
</div>

<!-- BOTÕES -->
<button onclick="abrirLista()">Lista de Aprovações</button>
<button onclick="abrirGerenciar()">Gerenciar Solicitações</button>

<!-- LISTA APROVAÇÃO -->
<div class="card" id="cardLista" style="display:none;">
<h2>Painel de Aprovação</h2>
<table>
<thead>
<tr>
<th>Terapeuta</th>
<th>Período</th>
<th>Status</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="listaAprovacao"></tbody>
</table>
</div>

<!-- GERENCIAR -->
<div class="card" id="cardGerenciar" style="display:none;">
<h2>Gerenciar Solicitações</h2>
<table>
<thead>
<tr>
<th>Terapeuta</th>
<th>Tipo</th>
<th>Período</th>
<th>Status</th>
<th>Ações</th>
</tr>
</thead>
<tbody id="listaGerenciar"></tbody>
</table>
</div>

</main>
</div>

<script>
const supabaseClient = supabase.createClient(
"https://rymehgsoarjeecuwyhny.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQi1730657485","exp":2086233485}"
);

function verificarSenha(){
  const senha = prompt("Digite a senha:");
  return senha === "2026";
}

/* ABRIR LISTA */
function abrirLista(){
  if(!verificarSenha()) return alert("Senha incorreta");

  document.getElementById("cardGerenciar").style.display = "none";
  document.getElementById("cardLista").style.display = "block";
  carregarListaAprovacao();
}

/* ABRIR GERENCIAR */
function abrirGerenciar(){
  if(!verificarSenha()) return alert("Senha incorreta");

  document.getElementById("cardLista").style.display = "none";
  document.getElementById("cardGerenciar").style.display = "block";
  carregarListaGerenciar();
}

/* CARREGAR TERAPEUTAS */
async function carregarTerapeutas(){
  const { data } = await supabaseClient
  .from("terapeutas")
  .select("cpf,nome_profissional")
  .eq("status","Ativo");

  const select = document.getElementById("terapeuta");
  select.innerHTML="";
  data.forEach(t=>{
    select.innerHTML+=`<option value="${t.cpf}">
      ${t.nome_profissional} - ${t.cpf}
    </option>`;
  });
}

/* SALVAR */
async function salvar(){
  const dataInicio=document.getElementById("data_inicio").value;
  const dataFim=document.getElementById("data_fim").value;

  if(dataFim < dataInicio){
    alert("Data fim não pode ser menor que início");
    return;
  }

  await supabaseClient.from("solicitacoes").insert({
    terapeuta_cpf: document.getElementById("terapeuta").value,
    tipo: document.getElementById("tipo").value,
    data_inicio:dataInicio,
    data_fim:dataFim,
    justificativa:document.getElementById("justificativa").value,
    status:"Pendente"
  });

  alert("Solicitação registrada!");
}

/* ALTERAR STATUS */
async function alterarStatus(id,status){
  await supabaseClient.from("solicitacoes")
  .update({status})
  .eq("id",id);

  carregarListaAprovacao();
}

/* EXCLUIR */
async function excluir(id){
  await supabaseClient.from("solicitacoes")
  .delete()
  .eq("id",id);

  carregarListaGerenciar();
}

/* CARREGAR LISTA APROVAÇÃO */
async function carregarListaAprovacao(){
  const {data}=await supabaseClient
  .from("solicitacoes")
  .select("*");

  const tbody=document.getElementById("listaAprovacao");
  tbody.innerHTML="";

  data.forEach(s=>{
    tbody.innerHTML+=`
    <tr>
      <td>${s.terapeuta_cpf}</td>
      <td>${s.data_inicio} → ${s.data_fim}</td>
      <td>${s.status}</td>
      <td>
        <button class="btn-icon btn-aprovar"
        onclick="alterarStatus('${s.id}','Aprovado')">✔</button>
        <button class="btn-icon btn-reprovar"
        onclick="alterarStatus('${s.id}','Reprovado')">✖</button>
      </td>
    </tr>`;
  });
}

/* CARREGAR GERENCIAR */
async function carregarListaGerenciar(){
  const {data}=await supabaseClient
  .from("solicitacoes")
  .select("*");

  const tbody=document.getElementById("listaGerenciar");
  tbody.innerHTML="";

  data.forEach(s=>{
    tbody.innerHTML+=`
    <tr>
      <td>${s.terapeuta_cpf}</td>
      <td>${s.tipo}</td>
      <td>${s.data_inicio} → ${s.data_fim}</td>
      <td>${s.status}</td>
      <td>
        <button onclick="excluir('${s.id}')"
        class="btn-danger">Excluir</button>
      </td>
    </tr>`;
  });
}

carregarTerapeutas();
</script>

</body>
</html>
