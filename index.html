<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard | Hara Spa</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<style>
body { margin:0; font-family:'Segoe UI'; background:#f5f7fb; }
.app { display:flex; min-height:100vh; }
.content { flex:1; padding:40px; margin-left:260px; }

.card {
  background:#fff;
  border-radius:25px;
  padding:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.top-cards {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:30px;
  margin-bottom:40px;
}

.big-number { font-size:60px; font-weight:bold; }

.workforce {
  background:#fff;
  border-radius:25px;
  padding:30px;
  display:flex;
  gap:40px;
}

.chart { flex:3; }

.bars {
  display:flex;
  align-items:flex-end;
  gap:12px;
  height:220px;
  margin-top:30px;
}

.bar {
  width:28px;
  background:#5b7dbd;
  border-radius:6px 6px 0 0;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  color:#fff;
  font-size:11px;
}

.hours {
  display:flex;
  justify-content:space-between;
  font-size:12px;
  margin-top:10px;
}

.work-info {
  flex:1;
  border-left:1px solid #ddd;
  padding-left:30px;
}
</style>
</head>
<body>

<div class="app">
  <aside id="sidebar"></aside>

  <main class="content">

    <div class="top-cards">
      <div class="card">
        <h3>Equipe</h3>
        <div class="big-number" id="totalEquipe">0</div>
        <p>Terapeutas ativas</p>
      </div>

      <div class="card">
        <h3>Resumo</h3>
        <p>Dados atualizados em tempo real</p>
      </div>

      <div class="card">
        <h3>Status</h3>
        <p>Sistema operacional</p>
      </div>
    </div>

    <div class="workforce">

      <div class="chart">
        <h3>For√ßa de Trabalho</h3>
        <div class="bars" id="bars"></div>
        <div class="hours" id="hours"></div>
      </div>

      <div class="work-info">
        <h3>Carga hor√°ria</h3>
        <div id="cargaHoraria"></div>
      </div>

    </div>

  </main>
</div>

<script src="assets/sidebar/sidebar.js"></script>

<script>
const supabaseClient = supabase.createClient(
  "https://rymehgsoarjeecuwyhny.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTc0ODUsImV4cCI6MjA4NjIzMzQ4NX0.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec"
);

async function carregarDashboard() {

  const { data, error } = await supabaseClient
    .from("terapeutas")
    .select("nome_profissional,hora_entrada,hora_saida,status")
    .eq("status","Ativo")
    .order("nome_profissional", { ascending: true });

  if (error) {
    console.error("Erro Supabase:", error);
    return;
  }

  // ===== TOTAL ATIVAS =====
  document.getElementById("totalEquipe").innerText = data.length;

  // ===== CARGA HOR√ÅRIA =====
  const cargaDiv = document.getElementById("cargaHoraria");
  cargaDiv.innerHTML = "";

  data.forEach(t => {

    if (!t.hora_entrada || !t.hora_saida) return;

    const [h1,m1] = t.hora_entrada.substring(0,5).split(":").map(Number);
    const [h2,m2] = t.hora_saida.substring(0,5).split(":").map(Number);

    const totalMin = (h2*60+m2) - (h1*60+m1);

    const horas = Math.floor(totalMin / 60);
    const minutos = totalMin % 60;

    cargaDiv.innerHTML += 
      `<p>${t.nome_profissional}: ${horas}:${minutos.toString().padStart(2,'0')} horas</p>`;
  });

  // ===== FOR√áA DE TRABALHO (9h √†s 21h) =====
  const inicioDia = 9;
  const fimDia = 21;

  const contagem = {};

  for (let h = inicioDia; h <= fimDia; h++) {
    contagem[h] = 0;
  }

  data.forEach(t => {

    if (!t.hora_entrada || !t.hora_saida) return;

    const [h1,m1] = t.hora_entrada.substring(0,5).split(":").map(Number);
    const [h2,m2] = t.hora_saida.substring(0,5).split(":").map(Number);

    const inicio = h1*60 + m1;
    const fim = h2*60 + m2;

    for (let h = inicioDia; h <= fimDia; h++) {

      const slotInicio = h * 60;
      const slotFim = (h + 1) * 60;

      // üîπ CORRE√á√ÉO FINAL AQUI
      if (inicio < slotFim && fim >= slotInicio) {
        contagem[h]++;
      }
    }
  });

  const barsDiv = document.getElementById("bars");
  const hoursDiv = document.getElementById("hours");

  barsDiv.innerHTML = "";
  hoursDiv.innerHTML = "";

  for (let h = inicioDia; h <= fimDia; h++) {

    const quantidade = contagem[h];
    const altura = quantidade * 25;

    barsDiv.innerHTML += `
      <div class="bar" style="height:${altura}px">
        ${quantidade}
      </div>
    `;

    hoursDiv.innerHTML += `<span>${h}:00</span>`;
  }

}

carregarDashboard();
</script>

</body>
</html>
