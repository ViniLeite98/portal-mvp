<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>In√≠cio</title>

<link rel="stylesheet" href="assets/css/style.css">
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.cards { display:grid; grid-template-columns:1.1fr 1.6fr 1.2fr; gap:16px; }
.card h3 { margin:0; font-size:14px; }
.kpi { font-size:34px; font-weight:bold; }
.small { font-size:12px; color:#666; }
.rank div { margin-bottom:6px; }
</style>
</head>

<body>

<nav class="sidebar">
  <h2>Hara Spa</h2>
  <a href="index.html"><i class="fa-solid fa-house"></i> In√≠cio</a>
  <a href="equipe.html"><i class="fa-solid fa-users"></i> Gest√£o da Equipe</a>
  <a href="solicitacoes.html"><i class="fa-solid fa-calendar-xmark"></i> Solicita√ß√µes</a>
  <a href="escalas.html"><i class="fa-solid fa-calendar-days"></i> Escalas</a>
</nav>

<div class="content">
  <h1>In√≠cio</h1>

  <!-- CARDS TOPO -->
  <div class="cards">

    <div class="card">
      <h3>Equipe üë•</h3>
      <div class="kpi" id="kpiEquipe">0</div>
      <div class="small">Funcion√°rias ativas no sistema</div>
    </div>

    <div class="card">
      <h3>Pr√≥ximas Datas üìÖ</h3>
      <div id="proxDatas" class="small"></div>
    </div>

    <div class="card">
      <h3>Dias Folgados üèÜ</h3>
      <div id="diasFolga" class="small"></div>
    </div>

  </div>

  <br>

  <!-- FOR√áA DE TRABALHO -->
  <div class="card">
    <h3>For√ßa de Trabalho</h3>
    <canvas id="grafico"></canvas>
    <div class="small">Distribui√ß√£o por hora (derivada do hor√°rio em Equipe).</div>
  </div>

  <br>

  <!-- CARGA HOR√ÅRIA -->
  <div class="card">
    <h3>Carga Hor√°ria</h3>
    <div id="rankHoras" class="rank small"></div>
  </div>

</div>

<script>
// ---------- LOAD ----------
const terapeutas = JSON.parse(localStorage.getItem("terapeutas")) || [];
const solicitacoes = JSON.parse(localStorage.getItem("solicitacoes")) || [];
const proximas = JSON.parse(localStorage.getItem("proximas_datas")) || [];

// ---------- KPI EQUIPE ----------
const ativas = terapeutas.filter(t =>
  !t.status || t.status === "Ativo"
);
document.getElementById("kpiEquipe").innerText = ativas.length;

// ---------- PR√ìXIMAS DATAS ----------
const proxDiv = document.getElementById("proxDatas");
if (proximas.length === 0) {
  proxDiv.innerHTML = "Sem datas cadastradas.";
} else {
  proximas
    .sort((a,b) => new Date(a.data) - new Date(b.data))
    .slice(0,4)
    .forEach(p => {
      proxDiv.innerHTML += `<div><b>${p.data}</b><br>${p.titulo || ""}</div>`;
    });
}

// ---------- DIAS FOLGADOS ----------
const aprovadas = solicitacoes.filter(s => s.status === "Aprovado");
const diasPorPessoa = {};

aprovadas.forEach(s => {
  const ini = new Date(s.inicio);
  const fim = new Date(s.fim);
  const dias = Math.floor((fim - ini)/(1000*60*60*24)) + 1;
  diasPorPessoa[s.terapeutaNome] =
    (diasPorPessoa[s.terapeutaNome] || 0) + dias;
});

const folgaDiv = document.getElementById("diasFolga");
Object.entries(diasPorPessoa)
  .sort((a,b) => b[1]-a[1])
  .slice(0,5)
  .forEach(([nome,dias]) => {
    folgaDiv.innerHTML += `<div><b>${nome}</b>: ${dias} dias</div>`;
  });

// ---------- FOR√áA DE TRABALHO ----------
const horas = Array.from({length:14}, (_,i)=>i+9);
const contagem = horas.map(h => {
  return ativas.filter(t => {
    if (!t.horaEntrada || !t.horaSaida) return false;
    return h >= Number(t.horaEntrada.split(":")[0]) &&
           h <  Number(t.horaSaida.split(":")[0]);
  }).length;
});

new Chart(document.getElementById("grafico"), {
  type: "bar",
  data: {
    labels: horas.map(h => `${h}:00`),
    datasets: [{
      label: "Terapeutas ativas",
      data: contagem
    }]
  }
});

// ---------- CARGA HOR√ÅRIA ----------
const horasRank = ativas.map(t => {
  if (!t.horaEntrada || !t.horaSaida) return null;
  const h = Number(t.horaSaida.split(":")[0]) -
            Number(t.horaEntrada.split(":")[0]);
  return { nome: t.nomeProfissional, horas: h };
}).filter(Boolean);

horasRank
  .sort((a,b)=>b.horas-a.horas)
  .slice(0,5)
  .forEach(r => {
    document.getElementById("rankHoras")
      .innerHTML += `<div>${r.nome}: ${r.horas}h</div>`;
  });
</script>

</body>
</html>
