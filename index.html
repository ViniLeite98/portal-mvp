<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Início | Hara Spa</title>

<link rel="stylesheet" href="assets/css/style.css">
<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<!-- SUPABASE (estável) -->
<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

<style>
.app { display:flex; min-height:100vh; background:#f5f7fb }
.main-content { flex:1; padding:30px }

.cards {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
  margin-top:24px;
}

.card {
  background:#fff;
  border-radius:20px;
  padding:20px;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
}

.big {
  font-size:42px;
  font-weight:700;
}

.dashboard-row {
  display:grid;
  grid-template-columns:3fr 1fr;
  gap:20px;
  margin-top:30px;
}

/* Força de trabalho */
.workforce {
  display:flex;
  align-items:flex-end;
  gap:14px;
  height:160px;
  margin-top:20px;
}

.bar-wrap {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}

.bar {
  width:30px;
  background:#4f6fad;
  border-radius:6px 6px 0 0;
}

.qtd { font-size:12px; font-weight:600 }
.hour { font-size:12px; color:#6b7280 }

/* Carga horária */
.carga p {
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  font-size:14px;
}
.carga span { font-weight:600 }
</style>
</head>

<body>

<div class="app">
  <aside id="sidebar"></aside>

  <main class="main-content">

    <h1>Início</h1>
    <p>Visão geral do Hara Spa</p>

    <!-- CARDS -->
    <div class="cards">

      <div class="card">
        <h3>Equipe</h3>
        <div id="total-equipe" class="big">--</div>
        <small>Total de terapeutas</small>
      </div>

      <div class="card">
        <h3>Próximas Datas</h3>
        <p>Em desenvolvimento</p>
      </div>

      <div class="card">
        <h3>Dias Folgados</h3>
        <p>Em desenvolvimento</p>
      </div>

    </div>

    <!-- FORÇA DE TRABALHO + CARGA -->
    <div class="dashboard-row">

      <div class="card">
        <h3>Força de Trabalho</h3>
        <div id="forca" class="workforce"></div>
      </div>

      <div class="card carga">
        <h3>Carga Horária</h3>
        <div id="carga">Carregando…</div>
      </div>

    </div>

  </main>
</div>

<script src="assets/sidebar/sidebar.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  if (!window.supabase) {
    alert("Supabase não carregou");
    return;
  }

  const supabaseClient = window.supabase.createClient(
    "https://rymehgsoarjeecuwyhny.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmVzc2UiLCJyZWYiOiJyeW1laGdzb2FyamVlY3V3eWhueSIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzcwNjU3NDg1LCJleHAiOjIwODYyMzM0ODV9.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec"
  );

  /* =========================
     BUSCA BASE (SEM FILTRO)
  ========================= */
  const { data, error } = await supabaseClient
    .from("terapeutas")
    .select("cpf,nome_profissi,hora_entrada,hora_saida,status");

  if (error) {
    console.error("Erro Supabase:", error);
    alert("Erro ao buscar terapeutas");
    return;
  }

  console.log("TERAPEUTAS:", data);

  /* =========================
     EQUIPE
  ========================= */
  document.getElementById("total-equipe").innerText = data.length;

  /* =========================
     FORÇA DE TRABALHO
  ========================= */
  const horas = {};
  for (let h = 9; h <= 21; h++) horas[h] = 0;

  data.forEach(t => {
    if (!t.hora_entrada || !t.hora_saida) return;

    const [hi, mi] = t.hora_entrada.split(":").map(Number);
    const [hf, mf] = t.hora_saida.split(":").map(Number);
    if ([hi,mi,hf,mf].some(isNaN)) return;

    const inicio = hi * 60 + mi;
    const fim = hf * 60 + mf;

    for (let h = 9; h <= 21; h++) {
      const ref = h * 60;
      if (inicio <= ref && ref < fim) horas[h]++;
    }
  });

  const forca = document.getElementById("forca");
  forca.innerHTML = "";

  Object.entries(horas).forEach(([h,q])=>{
    forca.innerHTML += `
      <div class="bar-wrap">
        <div class="qtd">${q}</div>
        <div class="bar" style="height:${q*16}px"></div>
        <div class="hour">${h}:00</div>
      </div>
    `;
  });

  /* =========================
     CARGA HORÁRIA
  ========================= */
  const carga = document.getElementById("carga");
  const lista = [];

  data.forEach(t => {
    if (!t.hora_entrada || !t.hora_saida) return;

    const [hi, mi] = t.hora_entrada.split(":").map(Number);
    const [hf, mf] = t.hora_saida.split(":").map(Number);
    if ([hi,mi,hf,mf].some(isNaN)) return;

    const totalMin = (hf*60+mf) - (hi*60+mi);
    if (totalMin <= 0) return;

    const h = Math.floor(totalMin/60);
    const m = totalMin%60;

    lista.push({
      nome: t.nome_profissi,
      minutos: totalMin,
      texto: `${h}:${m.toString().padStart(2,"0")}`
    });
  });

  if (lista.length === 0) {
    carga.innerHTML = "Sem dados válidos";
    return;
  }

  lista.sort((a,b)=>b.minutos-a.minutos);

  carga.innerHTML = "";
  lista.slice(0,3).forEach(t=>{
    carga.innerHTML += `
      <p>${t.nome}<span>${t.texto}h</span></p>
    `;
  });

});
</script>

</body>
</html>
