<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal MVP</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2e; --text:#e8eefc; --muted:#a9b6d6; --line:#22304f; --accent:#6aa6ff; --ok:#53d7a3; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#6aa6ff,#9b7bff)}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:260px 1fr;gap:16px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}

    .card{background:rgba(17,26,46,.9);border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    .hd{padding:14px 14px 0 14px}
    .bd{padding:14px}
    .ft{padding:14px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap}

    .btn{border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);
      padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:650;display:inline-flex;gap:10px;align-items:center}
    .btn:hover{border-color:rgba(106,166,255,.55);background:rgba(255,255,255,.06)}
    .btn.primary{border-color:rgba(106,166,255,.7);background:rgba(106,166,255,.12)}
    .btn.danger{border-color:rgba(255,107,107,.55);background:rgba(255,107,107,.10)}
    .btn.small{padding:8px 10px;border-radius:12px;font-weight:600}
    .nav{display:flex;flex-direction:column;gap:10px}
    .nav .btn{justify-content:flex-start;width:100%}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .status{font-weight:700}
    .status.SUBMITTED{color:var(--accent)}
    .status.IN_REVIEW{color:#ffd166}
    .status.APPROVED{color:var(--ok)}
    .status.REJECTED{color:var(--bad)}
    .status.DONE{color:#cdb4ff}
    .status.ACTIVE{color:var(--ok)}
    .status.INACTIVE{color:var(--bad)}

    label{display:block;margin:10px 0 6px;font-size:13px;color:var(--muted)}
    input, textarea, select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--text);outline:none
    }
    textarea{min-height:110px;resize:vertical}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
    @media (max-width:900px){.row4{grid-template-columns:1fr 1fr}}
    @media (max-width:700px){.row2,.row3,.row4{grid-template-columns:1fr}}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    td{padding:12px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
    tr td:first-child{border-radius:14px 0 0 14px}
    tr td:last-child{border-radius:0 14px 14px 0}
    .td-actions{white-space:nowrap;text-align:right}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .pill strong{color:var(--text)}

    .hidden{display:none}
    .note{font-size:12px;color:var(--muted);line-height:1.4}
    .sep{height:1px;background:var(--line);margin:12px 0}

    .badge { display:inline-flex; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03); font-size:12px; color:var(--muted); }

    .radioRow{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .radioRow label{margin:0;color:var(--text);font-size:13px;display:flex;gap:8px;align-items:center}
    .radioRow input{width:auto}

    .checkboxGrid{
      display:grid; grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px; margin-top:8px;
    }
    @media (max-width:900px){.checkboxGrid{grid-template-columns: repeat(3, minmax(0, 1fr));}}
    @media (max-width:700px){.checkboxGrid{grid-template-columns: repeat(2, minmax(0, 1fr));}}
    .checkItem{display:flex;gap:10px;align-items:flex-start}
    .checkItem input{width:auto;margin-top:3px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Portal MVP</h1>
            <div class="muted">HTML puro • Responsivo • Salva no navegador (LocalStorage)</div>
          </div>
        </div>

        <div class="kpi">
          <span class="pill">Total: <strong id="kpiTotal">0</strong></span>
          <span class="pill">Abertas: <strong id="kpiOpen">0</strong></span>
          <span class="pill">Aprovadas: <strong id="kpiApproved">0</strong></span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- NAV -->
      <section class="card">
        <div class="hd"><div class="muted">Navegação</div></div>
        <div class="bd">
          <div class="nav">
            <button class="btn primary" data-view="home">Início</button>
            <button class="btn" data-view="new">Nova solicitação</button>
            <button class="btn" data-view="list">Lista</button>
            <button class="btn" data-view="team">Equipe</button>
            <button class="btn" data-view="therapists">Terapeutas</button>
            <button class="btn" data-view="governance">Governança</button>
          </div>
          <div class="sep"></div>
          <div class="note">
            Dica: este MVP é “estático”. Depois a gente coloca login, banco e auditoria real.
          </div>
        </div>
        <div class="ft">
          <button class="btn danger small" id="btnReset">Zerar dados</button>
          <span class="note">Somente local</span>
        </div>
      </section>

      <!-- CONTENT -->
      <section class="card">
        <!-- HOME -->
        <div id="view-home">
          <div class="hd">
            <h2 style="margin:0;font-size:18px">Início</h2>
            <div class="muted">Fluxo mínimo: criar solicitação → mudar status → cadastrar equipe/terapeutas.</div>
          </div>
          <div class="bd">
            <div class="note">
              Este MVP funciona em celular e PC sem backend. Próxima etapa: autenticação + Postgres + auditoria imutável + RBAC.
            </div>
            <div class="sep"></div>
            <div class="row2">
              <div>
                <div class="pill">Objetivo</div>
                <p class="note">
                  Centralizar informações operacionais (cadastros e solicitações) com padrão de dados desde o início.
                </p>
              </div>
              <div>
                <div class="pill">O que já tem</div>
                <ul class="note" style="margin:8px 0 0 18px">
                  <li>Solicitações (criar e mudar status)</li>
                  <li>Equipe (cadastro básico)</li>
                  <li>Terapeutas (cadastro completo + certificações dinâmicas)</li>
                  <li>Persistência local (LocalStorage)</li>
                </ul>
              </div>
            </div>
            <div class="sep"></div>
            <button class="btn primary" data-view="therapists">Cadastrar terapeuta</button>
          </div>
        </div>

        <!-- NEW -->
        <div id="view-new" class="hidden">
          <div class="hd">
            <h2 style="margin:0;font-size:18px">Nova solicitação</h2>
            <div class="muted">Preencha e salve. Depois você altera o status na lista.</div>
          </div>
          <div class="bd">
            <div class="row2">
              <div>
                <label for="title">Título</label>
                <input id="title" placeholder="Ex.: Pedido de material / Ajuste de agenda" />
              </div>
              <div>
                <label for="type">Tipo</label>
                <select id="type">
                  <option value="RH">RH</option>
                  <option value="Materiais">Materiais</option>
                  <option value="Agenda">Agenda</option>
                  <option value="Financeiro">Financeiro</option>
                  <option value="Outro">Outro</option>
                </select>
              </div>
            </div>

            <label for="desc">Descrição</label>
            <textarea id="desc" placeholder="Descreva o pedido, contexto e urgência..."></textarea>

            <div class="row2">
              <div>
                <label for="requester">Solicitante</label>
                <input id="requester" placeholder="Ex.: Gabriel" />
              </div>
              <div>
                <label for="approver">Aprovador (texto)</label>
                <input id="approver" placeholder="Ex.: Coordenação / Gestão" />
              </div>
            </div>

            <div class="sep"></div>
            <button class="btn primary" id="btnCreate">Salvar solicitação</button>
            <span class="note" id="createMsg" style="margin-left:10px"></span>
          </div>
        </div>

        <!-- LIST -->
        <div id="view-list" class="hidden">
          <div class="hd">
            <h2 style="margin:0;font-size:18px">Lista de solicitações</h2>
            <div class="muted">Ações: mudar status e excluir. Tudo fica salvo no navegador.</div>
          </div>
          <div class="bd">
            <div class="row2">
              <div>
                <label for="filterStatus">Filtrar por status</label>
                <select id="filterStatus">
                  <option value="ALL">Todos</option>
                  <option value="SUBMITTED">SUBMITTED</option>
                  <option value="IN_REVIEW">IN_REVIEW</option>
                  <option value="APPROVED">APPROVED</option>
                  <option value="REJECTED">REJECTED</option>
                  <option value="DONE">DONE</option>
                </select>
              </div>
              <div>
                <label for="q">Buscar</label>
                <input id="q" placeholder="Buscar por título/descrição/solicitante..." />
              </div>
            </div>

            <div class="sep"></div>

            <table>
              <tbody id="rows"></tbody>
            </table>

            <div class="note" id="emptyMsg"></div>
          </div>
        </div>

        <!-- TEAM -->
        <div id="view-team" class="hidden">
          <div class="hd">
            <h2 style="margin:0;font-size:18px">Equipe</h2>
            <div class="muted">Cadastro simples de pessoas e papéis. Salvo no navegador.</div>
          </div>
          <div class="bd">
            <div class="row2">
              <div>
                <label for="team_name">Nome</label>
                <input id="team_name" placeholder="Ex.: Agatha Silva" />
              </div>
              <div>
                <label for="team_email">E-mail</label>
                <input id="team_email" placeholder="ex.: agatha@empresa.com" />
              </div>
            </div>

            <div class="row2">
              <div>
                <label for="team_role">Papel</label>
                <select id="team_role">
                  <option value="requester">Solicitante</option>
                  <option value="approver">Aprovador</option>
                  <option value="admin">Admin</option>
                  <option value="auditor">Auditor</option>
                </select>
              </div>
              <div>
                <label for="team_area">Área</label>
                <input id="team_area" placeholder="Ex.: RH, Financeiro, Operações" />
              </div>
            </div>

            <div class="row2">
              <div>
                <label for="team_unit">Unidade / Diretoria</label>
                <input id="team_unit" placeholder="Ex.: Centro / Norte 1 / etc." />
              </div>
              <div>
                <label for="team_phone">Telefone</label>
                <input id="team_phone" placeholder="Ex.: (11) 99999-9999" />
              </div>
            </div>

            <div class="sep"></div>
            <button class="btn primary" id="btnTeamAdd">Adicionar membro</button>
            <span class="note" id="teamMsg" style="margin-left:10px"></span>

            <div class="sep"></div>

            <div class="row2">
              <div>
                <label for="team_filter_role">Filtrar por papel</label>
                <select id="team_filter_role">
                  <option value="ALL">Todos</option>
                  <option value="requester">Solicitante</option>
                  <option value="approver">Aprovador</option>
                  <option value="admin">Admin</option>
                  <option value="auditor">Auditor</option>
                </select>
              </div>
              <div>
                <label for="team_q">Buscar</label>
                <input id="team_q" placeholder="Buscar por nome/área/unidade..." />
              </div>
            </div>

            <div class="sep"></div>

            <table>
              <tbody id="team_rows"></tbody>
            </table>

            <div class="note" id="teamEmptyMsg"></div>
          </div>
        </div>

        <!-- THERAPISTS -->
        <div id="view-therapists" class="hidden">
          <div class="hd">
            <h2 style="margin:0;font-size:18px" id="th_title">Terapeutas</h2>
            <div class="muted" id="th_subtitle">Cadastro completo (como no print) + certificações dinâmicas.</div>
          </div>

          <div class="bd">
            <!-- LISTA -->
            <div id="th_list_block">
              <div class="row2">
                <div>
                  <label for="th_filter_status">Filtrar por status</label>
                  <select id="th_filter_status">
                    <option value="ALL">Todos</option>
                    <option value="ACTIVE">Ativo</option>
                    <option value="INACTIVE">Inativo</option>
                  </select>
                </div>
                <div>
                  <label for="th_q">Buscar</label>
                  <input id="th_q" placeholder="Buscar por nome, unidade, CPF, e-mail..." />
                </div>
              </div>

              <div class="sep"></div>
              <button class="btn primary" id="btnThNew">Novo terapeuta</button>

              <div class="sep"></div>

              <table>
                <tbody id="th_rows"></tbody>
              </table>

              <div class="note" id="th_emptyMsg"></div>
            </div>

            <!-- FORM -->
            <div id="th_form_block" class="hidden">
              <div class="note" style="margin-bottom:10px">Preencha os dados da terapeuta</div>

              <div class="row2">
                <div>
                  <label for="th_fullName">Nome Completo *</label>
                  <input id="th_fullName" placeholder="Ex.: Isadora Lorente" />
                </div>
                <div>
                  <label for="th_profName">Nome profissional *</label>
                  <input id="th_profName" placeholder="Ex.: Agatha" />
                </div>
              </div>

              <div class="row4">
                <div>
                  <label for="th_birth">Data de Nascimento *</label>
                  <input id="th_birth" type="date" />
                </div>
                <div>
                  <label for="th_cpf">CPF* (11 dígitos)</label>
                  <input id="th_cpf" inputmode="numeric" placeholder="Somente números" maxlength="11" />
                </div>
                <div>
                  <label for="th_email">Email *</label>
                  <input id="th_email" type="email" placeholder="ex.: nome@email.com" />
                </div>
                <div>
                  <label for="th_unit">Unidade *</label>
                  <select id="th_unit"></select>
                </div>
              </div>

              <div class="row3">
                <div style="grid-column: 1 / span 1;">
                  <label for="th_address">Endereço</label>
                  <input id="th_address" placeholder="Ex.: Rua 2" />
                </div>
                <div>
                  <label for="th_contact">Contato *</label>
                  <input id="th_contact" inputmode="numeric" placeholder="Somente números" />
                </div>
                <div>
                  <label for="th_emergency">Contato Emergência</label>
                  <input id="th_emergency" inputmode="numeric" placeholder="Somente números" />
                </div>
              </div>

              <div class="row4">
                <div>
                  <label for="th_pixType">Tipo de Chave Pix</label>
                  <select id="th_pixType">
                    <option value="CPF">CPF</option>
                    <option value="EMAIL">E-mail</option>
                    <option value="TELEFONE">Telefone</option>
                    <option value="ALEATORIA">Aleatória</option>
                  </select>
                </div>
                <div>
                  <label for="th_pixKey">Chave Pix</label>
                  <input id="th_pixKey" placeholder="Digite a chave" />
                </div>
                <div>
                  <label for="th_hasWeeklyOff">Tem folga semanal? *</label>
                  <select id="th_hasWeeklyOff">
                    <option value="SIM">Sim</option>
                    <option value="NAO">Não</option>
                  </select>
                </div>
                <div>
                  <label for="th_dayOff">Dia da Folga</label>
                  <select id="th_dayOff">
                    <option value="">—</option>
                    <option>Segunda</option>
                    <option>Terça</option>
                    <option>Quarta</option>
                    <option>Quinta</option>
                    <option>Sexta</option>
                    <option>Sábado</option>
                    <option>Domingo</option>
                  </select>
                </div>
              </div>

              <div class="row4">
                <div>
                  <label for="th_startTime">Horário de Entrada *</label>
                  <select id="th_startTime"></select>
                </div>
                <div>
                  <label for="th_endTime">Horário de Saída *</label>
                  <select id="th_endTime"></select>
                </div>
                <div>
                  <label for="th_startDate">Data de Início *</label>
                  <input id="th_startDate" type="date" />
                </div>
                <div>
                  <label for="th_blood">Tipo Sanguíneo</label>
                  <select id="th_blood">
                    <option value="">—</option>
                    <option>A+</option><option>A-</option>
                    <option>B+</option><option>B-</option>
                    <option>AB+</option><option>AB-</option>
                    <option>O+</option><option>O-</option>
                  </select>
                </div>
              </div>

              <div class="row2">
                <div>
                  <label>Status *</label>
                  <div class="radioRow">
                    <label><input type="radio" name="th_status" value="ACTIVE" checked /> Ativo</label>
                    <label><input type="radio" name="th_status" value="INACTIVE" /> Inativo</label>
                  </div>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <div class="note">Campos com * são obrigatórios.</div>
                </div>
              </div>

              <div class="sep"></div>

              <h3 style="margin:0 0 8px 0;font-size:18px">Certificações</h3>

              <div class="row2">
                <div>
                  <label for="th_newCert">Incluir nova certificação</label>
                  <input id="th_newCert" placeholder="Ex.: Massagem Desportiva" />
                </div>
                <div style="display:flex;gap:10px;align-items:flex-end">
                  <button class="btn" id="btnAddCert">Adicionar certificação</button>
                  <span class="note" id="th_certMsg"></span>
                </div>
              </div>

              <div class="checkboxGrid" id="th_certsGrid"></div>

              <div class="sep"></div>

              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn primary" id="btnThSave">Salvar</button>
                <button class="btn" id="btnThCancel">Cancelar</button>
                <span class="note" id="th_formMsg"></span>
              </div>
            </div>

          </div>
        </div>

        <!-- GOVERNANCE -->
        <div id="view-governance" class="hidden">
          <div class="hd">
            <h2 style="margin:0;font-size:18px">Governança (versão MVP)</h2>
            <div class="muted">Regras simples que viram “produto” quando tiver backend.</div>
          </div>
          <div class="bd">
            <div class="pill">Regras mínimas recomendadas</div>
            <ul class="note" style="margin:10px 0 0 18px; line-height:1.6">
              <li><strong>Padronização:</strong> todo cadastro tem campos obrigatórios e validação.</li>
              <li><strong>Domínios controlados:</strong> selects para Unidade, Pix, Folga, Horários, Tipo sanguíneo.</li>
              <li><strong>Auditoria:</strong> no backend, vira trilha imutável de alterações (quem/quando/o quê).</li>
              <li><strong>RBAC:</strong> papéis (admin/approver/auditor) para controlar telas e ações.</li>
              <li><strong>LGPD:</strong> CPF/telefone/e-mail como dados pessoais; definir retenção e acesso.</li>
            </ul>
          </div>
        </div>

      </section>
    </div>
  </main>

  <script>
    // ---------------------------
    // Utils
    // ---------------------------
    function nowISO() { return new Date().toISOString(); }
    function uid() { return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }

    function fmt(iso) {
      try { return new Date(iso).toLocaleString("pt-BR"); }
      catch { return iso; }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function onlyDigits(s) { return (s || "").replace(/\D/g, ""); }

    // ---------------------------
    // Navigation
    // ---------------------------
    function setView(name) {
      const views = ["home","new","list","team","therapists","governance"];
      for (const v of views) {
        document.getElementById("view-" + v).classList.toggle("hidden", v !== name);
      }
      if (name === "list") renderList();
      if (name === "team") renderTeam();
      if (name === "therapists") renderTherapistsList();
    }

    document.querySelectorAll("[data-view]").forEach(btn => {
      btn.addEventListener("click", () => setView(btn.getAttribute("data-view")));
    });

    // ---------------------------
    // Requests (Solicitações)
    // ---------------------------
    const REQ_KEY = "portal_mvp_requests_v1";

    function loadReq() {
      try { return JSON.parse(localStorage.getItem(REQ_KEY) || "[]"); }
      catch { return []; }
    }
    function saveReq(items) { localStorage.setItem(REQ_KEY, JSON.stringify(items)); }

    function auditLocal(item, action, details) {
      item.audit = item.audit || [];
      item.audit.push({ at: nowISO(), action, details });
    }

    function createRequest() {
      const title = document.getElementById("title").value.trim();
      const type = document.getElementById("type").value;
      const description = document.getElementById("desc").value.trim();
      const requester = document.getElementById("requester").value.trim();
      const approver = document.getElementById("approver").value.trim();
      const msg = document.getElementById("createMsg");

      if (!title || !description || !requester) {
        msg.textContent = "Preencha Título, Descrição e Solicitante.";
        msg.style.color = "var(--bad)";
        return;
      }

      const items = loadReq();
      const item = {
        id: uid(),
        title, type, description, requester, approver,
        status: "SUBMITTED",
        created_at: nowISO(),
        updated_at: nowISO(),
        audit: []
      };
      auditLocal(item, "create", { status: "SUBMITTED" });

      items.unshift(item);
      saveReq(items);

      document.getElementById("title").value = "";
      document.getElementById("desc").value = "";
      document.getElementById("requester").value = "";
      document.getElementById("approver").value = "";

      msg.textContent = "Solicitação salva.";
      msg.style.color = "var(--ok)";

      updateKpis();
      setView("list");
    }

    function changeStatus(id, newStatus) {
      const items = loadReq();
      const idx = items.findIndex(x => x.id === id);
      if (idx < 0) return;

      const before = items[idx].status;
      items[idx].status = newStatus;
      items[idx].updated_at = nowISO();
      auditLocal(items[idx], "status_change", { from: before, to: newStatus });

      saveReq(items);
      renderList();
      updateKpis();
    }

    function removeRequest(id) {
      const items = loadReq().filter(x => x.id !== id);
      saveReq(items);
      renderList();
      updateKpis();
    }

    function renderList() {
      const tbody = document.getElementById("rows");
      const empty = document.getElementById("emptyMsg");
      const filterStatus = document.getElementById("filterStatus").value;
      const q = document.getElementById("q").value.trim().toLowerCase();

      const items = loadReq().filter(item => {
        const okStatus = (filterStatus === "ALL") || (item.status === filterStatus);
        const hay = (item.title + " " + item.description + " " + item.requester + " " + item.type).toLowerCase();
        const okQ = !q || hay.includes(q);
        return okStatus && okQ;
      });

      tbody.innerHTML = "";
      if (items.length === 0) { empty.textContent = "Nenhuma solicitação encontrada."; return; }
      empty.textContent = "";

      for (const item of items) {
        const tr = document.createElement("tr");

        const left = document.createElement("td");
        left.innerHTML = `
          <div>
            <div style="font-weight:750">${escapeHtml(item.title)}</div>
            <div class="muted" style="margin-top:4px">
              <span class="pill" style="margin-right:8px">${escapeHtml(item.type)}</span>
              <span class="status ${item.status}">${item.status}</span>
            </div>
            <div class="note" style="margin-top:8px">${escapeHtml(item.description)}</div>
            <div class="muted" style="margin-top:8px">
              Solicitante: <strong style="color:var(--text)">${escapeHtml(item.requester)}</strong>
              ${item.approver ? ` • Aprovador: <strong style="color:var(--text)">${escapeHtml(item.approver)}</strong>` : ""}
            </div>
            <div class="muted" style="margin-top:6px">
              Criado: ${fmt(item.created_at)} • Atualizado: ${fmt(item.updated_at)}
            </div>
          </div>
        `;
        tr.appendChild(left);

        const right = document.createElement("td");
        right.className = "td-actions";
        right.innerHTML = `
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn small" data-act="IN_REVIEW">Revisar</button>
            <button class="btn small" data-act="APPROVED">Aprovar</button>
            <button class="btn small" data-act="REJECTED">Rejeitar</button>
            <button class="btn small" data-act="DONE">Concluir</button>
            <button class="btn danger small" data-act="DELETE">Excluir</button>
          </div>
        `;
        right.querySelectorAll("button").forEach(btn => {
          btn.addEventListener("click", () => {
            const act = btn.getAttribute("data-act");
            if (act === "DELETE") removeRequest(item.id);
            else changeStatus(item.id, act);
          });
        });

        tr.appendChild(right);
        tbody.appendChild(tr);
      }
    }

    function updateKpis() {
      const items = loadReq();
      const total = items.length;
      const open = items.filter(x => x.status === "SUBMITTED" || x.status === "IN_REVIEW").length;
      const approved = items.filter(x => x.status === "APPROVED").length;

      document.getElementById("kpiTotal").textContent = String(total);
      document.getElementById("kpiOpen").textContent = String(open);
      document.getElementById("kpiApproved").textContent = String(approved);
    }

    document.getElementById("btnCreate").addEventListener("click", createRequest);
    document.getElementById("filterStatus").addEventListener("change", renderList);
    document.getElementById("q").addEventListener("input", renderList);

    // ---------------------------
    // Team (Equipe)
    // ---------------------------
    const TEAM_KEY = "portal_mvp_team_v1";

    function loadTeam() {
      try { return JSON.parse(localStorage.getItem(TEAM_KEY) || "[]"); }
      catch { return []; }
    }
    function saveTeam(items) { localStorage.setItem(TEAM_KEY, JSON.stringify(items)); }

    function addTeamMember() {
      const name = document.getElementById("team_name").value.trim();
      const email = document.getElementById("team_email").value.trim();
      const role = document.getElementById("team_role").value;
      const area = document.getElementById("team_area").value.trim();
      const unit = document.getElementById("team_unit").value.trim();
      const phone = document.getElementById("team_phone").value.trim();
      const msg = document.getElementById("teamMsg");

      if (!name) {
        msg.textContent = "Informe o nome.";
        msg.style.color = "var(--bad)";
        return;
      }

      const items = loadTeam();
      items.unshift({ id: uid(), name, email, role, area, unit, phone, created_at: nowISO() });
      saveTeam(items);

      document.getElementById("team_name").value = "";
      document.getElementById("team_email").value = "";
      document.getElementById("team_area").value = "";
      document.getElementById("team_unit").value = "";
      document.getElementById("team_phone").value = "";

      msg.textContent = "Membro adicionado.";
      msg.style.color = "var(--ok)";
      renderTeam();
    }

    function removeTeamMember(id) {
      saveTeam(loadTeam().filter(x => x.id !== id));
      renderTeam();
    }

    function renderTeam() {
      const tbody = document.getElementById("team_rows");
      const empty = document.getElementById("teamEmptyMsg");
      const filterRole = document.getElementById("team_filter_role").value;
      const q = document.getElementById("team_q").value.trim().toLowerCase();

      const items = loadTeam().filter(item => {
        const okRole = (filterRole === "ALL") || (item.role === filterRole);
        const hay = (item.name + " " + (item.area||"") + " " + (item.unit||"") + " " + (item.email||"")).toLowerCase();
        const okQ = !q || hay.includes(q);
        return okRole && okQ;
      });

      tbody.innerHTML = "";
      if (items.length === 0) { empty.textContent = "Nenhum membro cadastrado."; return; }
      empty.textContent = "";

      for (const m of items) {
        const tr = document.createElement("tr");

        const left = document.createElement("td");
        left.innerHTML = `
          <div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <div style="font-weight:750">${escapeHtml(m.name)}</div>
              <span class="badge">${escapeHtml(m.role)}</span>
              ${m.area ? `<span class="badge">${escapeHtml(m.area)}</span>` : ""}
              ${m.unit ? `<span class="badge">${escapeHtml(m.unit)}</span>` : ""}
            </div>
            <div class="muted" style="margin-top:8px">
              ${m.email ? `E-mail: <strong style="color:var(--text)">${escapeHtml(m.email)}</strong>` : ""}
              ${m.phone ? ` ${m.email ? "•" : ""} Telefone: <strong style="color:var(--text)">${escapeHtml(m.phone)}</strong>` : ""}
            </div>
            <div class="muted" style="margin-top:6px">Criado: ${fmt(m.created_at)}</div>
          </div>
        `;
        tr.appendChild(left);

        const right = document.createElement("td");
        right.className = "td-actions";
        right.innerHTML = `<button class="btn danger small">Excluir</button>`;
        right.querySelector("button").addEventListener("click", () => removeTeamMember(m.id));
        tr.appendChild(right);

        tbody.appendChild(tr);
      }
    }

    document.getElementById("btnTeamAdd").addEventListener("click", addTeamMember);
    document.getElementById("team_filter_role").addEventListener("change", renderTeam);
    document.getElementById("team_q").addEventListener("input", renderTeam);

    // ---------------------------
    // Therapists (Terapeutas)
    // ---------------------------
    const TH_KEY = "portal_mvp_therapists_v1";
    const CERT_KEY = "portal_mvp_cert_options_v1";

    const DEFAULT_UNITS = ["Unidade 1", "Unidade 2", "Unidade 3"];
    const DEFAULT_CERTS = ["Massagem Nuru", "Massagem Vivência", "Podolatria", "Massagem Casais", "Massagem Feminina"];

    let editingTherapistId = null;

    function loadTherapists() {
      try { return JSON.parse(localStorage.getItem(TH_KEY) || "[]"); }
      catch { return []; }
    }
    function saveTherapists(items) { localStorage.setItem(TH_KEY, JSON.stringify(items)); }

    function loadCertOptions() {
      try {
        const v = JSON.parse(localStorage.getItem(CERT_KEY) || "null");
        return Array.isArray(v) && v.length ? v : DEFAULT_CERTS.slice();
      } catch { return DEFAULT_CERTS.slice(); }
    }
    function saveCertOptions(items) { localStorage.setItem(CERT_KEY, JSON.stringify(items)); }

    function populateUnits() {
      const sel = document.getElementById("th_unit");
      sel.innerHTML = "";
      for (const u of DEFAULT_UNITS) {
        const opt = document.createElement("option");
        opt.value = u; opt.textContent = u;
        sel.appendChild(opt);
      }
    }

    function populateTimes() {
      const startSel = document.getElementById("th_startTime");
      const endSel = document.getElementById("th_endTime");
      startSel.innerHTML = ""; endSel.innerHTML = "";

      // 06:00 até 23:00 de 30 em 30
      for (let h=6; h<=23; h++) {
        for (let m=0; m<60; m+=30) {
          const t = String(h).padStart(2,"0") + ":" + String(m).padStart(2,"0");
          const o1 = document.createElement("option"); o1.value=t; o1.textContent=t;
          const o2 = document.createElement("option"); o2.value=t; o2.textContent=t;
          startSel.appendChild(o1); endSel.appendChild(o2);
        }
      }
      startSel.value = "09:00";
      endSel.value = "17:00";
    }

    function getStatusValue() {
      const radios = document.querySelectorAll('input[name="th_status"]');
      for (const r of radios) if (r.checked) return r.value;
      return "ACTIVE";
    }

    function setStatusValue(v) {
      document.querySelectorAll('input[name="th_status"]').forEach(r => r.checked = (r.value === v));
    }

    function renderCertCheckboxes(selected = []) {
      const grid = document.getElementById("th_certsGrid");
      const opts = loadCertOptions();
      grid.innerHTML = "";

      for (const name of opts) {
        const id = "cert_" + name.toLowerCase().replace(/\s+/g,"_").replace(/[^\w_]/g,"");
        const wrap = document.createElement("label");
        wrap.className = "checkItem";
        wrap.innerHTML = `
          <input type="checkbox" value="${escapeHtml(name)}" id="${id}">
          <span>${escapeHtml(name)}</span>
        `;
        grid.appendChild(wrap);
        const cb = wrap.querySelector("input");
        cb.checked = selected.includes(name);
      }
    }

    function openTherapistForm(idOrNull) {
      editingTherapistId = idOrNull || null;

      document.getElementById("th_list_block").classList.add("hidden");
      document.getElementById("th_form_block").classList.remove("hidden");

      document.getElementById("th_formMsg").textContent = "";
      document.getElementById("th_certMsg").textContent = "";
      document.getElementById("th_newCert").value = "";

      if (!editingTherapistId) {
        document.getElementById("th_title").textContent = "Novo Terapeuta";
        // defaults
        document.getElementById("th_fullName").value = "";
        document.getElementById("th_profName").value = "";
        document.getElementById("th_birth").value = "";
        document.getElementById("th_cpf").value = "";
        document.getElementById("th_email").value = "";
        document.getElementById("th_unit").value = DEFAULT_UNITS[0] || "";
        document.getElementById("th_address").value = "";
        document.getElementById("th_contact").value = "";
        document.getElementById("th_emergency").value = "";
        document.getElementById("th_pixType").value = "CPF";
        document.getElementById("th_pixKey").value = "";
        document.getElementById("th_hasWeeklyOff").value = "SIM";
        document.getElementById("th_dayOff").value = "Terça";
        document.getElementById("th_startTime").value = "09:00";
        document.getElementById("th_endTime").value = "17:00";
        document.getElementById("th_startDate").value = "";
        document.getElementById("th_blood").value = "";
        setStatusValue("ACTIVE");
        renderCertCheckboxes([]);
        syncDayOffEnabled();
        return;
      }

      document.getElementById("th_title").textContent = "Editar Terapeuta";
      const th = loadTherapists().find(x => x.id === editingTherapistId);
      if (!th) { cancelTherapistForm(); return; }

      document.getElementById("th_fullName").value = th.fullName || "";
      document.getElementById("th_profName").value = th.profName || "";
      document.getElementById("th_birth").value = th.birth || "";
      document.getElementById("th_cpf").value = th.cpf || "";
      document.getElementById("th_email").value = th.email || "";
      document.getElementById("th_unit").value = th.unit || (DEFAULT_UNITS[0] || "");
      document.getElementById("th_address").value = th.address || "";
      document.getElementById("th_contact").value = th.contact || "";
      document.getElementById("th_emergency").value = th.emergency || "";
      document.getElementById("th_pixType").value = th.pixType || "CPF";
      document.getElementById("th_pixKey").value = th.pixKey || "";
      document.getElementById("th_hasWeeklyOff").value = th.hasWeeklyOff || "SIM";
      document.getElementById("th_dayOff").value = th.dayOff || "";
      document.getElementById("th_startTime").value = th.startTime || "09:00";
      document.getElementById("th_endTime").value = th.endTime || "17:00";
      document.getElementById("th_startDate").value = th.startDate || "";
      document.getElementById("th_blood").value = th.blood || "";
      setStatusValue(th.status || "ACTIVE");
      renderCertCheckboxes(th.certs || []);
      syncDayOffEnabled();
    }

    function cancelTherapistForm() {
      editingTherapistId = null;
      document.getElementById("th_form_block").classList.add("hidden");
      document.getElementById("th_list_block").classList.remove("hidden");
      document.getElementById("th_title").textContent = "Terapeutas";
      renderTherapistsList();
    }

    function syncDayOffEnabled() {
      const hasOff = document.getElementById("th_hasWeeklyOff").value;
      const daySel = document.getElementById("th_dayOff");
      daySel.disabled = (hasOff !== "SIM");
      if (hasOff !== "SIM") daySel.value = "";
      if (hasOff === "SIM" && !daySel.value) daySel.value = "Terça";
    }

    function getSelectedCerts() {
      const grid = document.getElementById("th_certsGrid");
      const selected = [];
      grid.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb.checked) selected.push(cb.value);
      });
      return selected;
    }

    function validateTherapist(data) {
      const errs = [];

      if (!data.fullName) errs.push("Nome Completo");
      if (!data.profName) errs.push("Nome profissional");
      if (!data.birth) errs.push("Data de Nascimento");
      if (!data.email) errs.push("Email");
      if (!data.unit) errs.push("Unidade");
      if (!data.contact) errs.push("Contato");
      if (!data.startTime) errs.push("Horário de Entrada");
      if (!data.endTime) errs.push("Horário de Saída");
      if (!data.startDate) errs.push("Data de Início");

      const cpf = onlyDigits(data.cpf || "");
      if (cpf.length !== 11) errs.push("CPF (11 dígitos)");

      // regra simples: se tem folga semanal, exige dia
      if (data.hasWeeklyOff === "SIM" && !data.dayOff) errs.push("Dia da Folga");

      // contato numérico
      if (onlyDigits(data.contact || "").length < 8) errs.push("Contato (mín. 8 dígitos)");

      return errs;
    }

    function saveTherapist() {
      const msg = document.getElementById("th_formMsg");
      msg.textContent = "";

      const data = {
        id: editingTherapistId || uid(),
        fullName: document.getElementById("th_fullName").value.trim(),
        profName: document.getElementById("th_profName").value.trim(),
        birth: document.getElementById("th_birth").value,
        cpf: onlyDigits(document.getElementById("th_cpf").value),
        email: document.getElementById("th_email").value.trim(),
        unit: document.getElementById("th_unit").value,
        address: document.getElementById("th_address").value.trim(),
        contact: onlyDigits(document.getElementById("th_contact").value),
        emergency: onlyDigits(document.getElementById("th_emergency").value),
        pixType: document.getElementById("th_pixType").value,
        pixKey: document.getElementById("th_pixKey").value.trim(),
        hasWeeklyOff: document.getElementById("th_hasWeeklyOff").value,
        dayOff: document.getElementById("th_dayOff").value,
        startTime: document.getElementById("th_startTime").value,
        endTime: document.getElementById("th_endTime").value,
        startDate: document.getElementById("th_startDate").value,
        blood: document.getElementById("th_blood").value,
        status: getStatusValue(),
        certs: getSelectedCerts(),
        updated_at: nowISO()
      };

      const errs = validateTherapist(data);
      if (errs.length) {
        msg.textContent = "Preencha corretamente: " + errs.join(", ") + ".";
        msg.style.color = "var(--bad)";
        return;
      }

      const items = loadTherapists();
      const idx = items.findIndex(x => x.id === data.id);

      if (idx >= 0) {
        const before = items[idx];
        items[idx] = { ...before, ...data };
      } else {
        data.created_at = nowISO();
        items.unshift(data);
      }

      saveTherapists(items);
      msg.textContent = "Salvo.";
      msg.style.color = "var(--ok)";

      cancelTherapistForm();
    }

    function removeTherapist(id) {
      if (!confirm("Excluir este terapeuta?")) return;
      saveTherapists(loadTherapists().filter(x => x.id !== id));
      renderTherapistsList();
    }

    function renderTherapistsList() {
      const tbody = document.getElementById("th_rows");
      const empty = document.getElementById("th_emptyMsg");
      const filterStatus = document.getElementById("th_filter_status").value;
      const q = document.getElementById("th_q").value.trim().toLowerCase();

      const items = loadTherapists().filter(t => {
        const okStatus = (filterStatus === "ALL") || (t.status === filterStatus);
        const hay = (t.fullName + " " + t.profName + " " + t.unit + " " + t.cpf + " " + t.email).toLowerCase();
        const okQ = !q || hay.includes(q);
        return okStatus && okQ;
      });

      tbody.innerHTML = "";
      if (items.length === 0) { empty.textContent = "Nenhum terapeuta cadastrado."; return; }
      empty.textContent = "";

      for (const t of items) {
        const tr = document.createElement("tr");

        const left = document.createElement("td");
        left.innerHTML = `
          <div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <div style="font-weight:750">${escapeHtml(t.profName || t.fullName)}</div>
              <span class="badge">${escapeHtml(t.unit || "")}</span>
              <span class="status ${t.status}">${t.status === "ACTIVE" ? "Ativo" : "Inativo"}</span>
            </div>
            <div class="muted" style="margin-top:8px">
              Nome completo: <strong style="color:var(--text)">${escapeHtml(t.fullName || "")}</strong>
            </div>
            <div class="muted" style="margin-top:6px">
              CPF: <strong style="color:var(--text)">${escapeHtml(t.cpf || "")}</strong>
              • Email: <strong style="color:var(--text)">${escapeHtml(t.email || "")}</strong>
            </div>
            <div class="muted" style="margin-top:6px">
              Entrada: <strong style="color:var(--text)">${escapeHtml(t.startTime || "")}</strong>
              • Saída: <strong style="color:var(--text)">${escapeHtml(t.endTime || "")}</strong>
              • Início: <strong style="color:var(--text)">${escapeHtml(t.startDate || "")}</strong>
            </div>
          </div>
        `;
        tr.appendChild(left);

        const right = document.createElement("td");
        right.className = "td-actions";
        right.innerHTML = `
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn small" data-act="EDIT">Editar</button>
            <button class="btn danger small" data-act="DELETE">Excluir</button>
          </div>
        `;
        right.querySelector('[data-act="EDIT"]').addEventListener("click", () => openTherapistForm(t.id));
        right.querySelector('[data-act="DELETE"]').addEventListener("click", () => removeTherapist(t.id));
        tr.appendChild(right);

        tbody.appendChild(tr);
      }
    }

    function addCertificationOption() {
      const input = document.getElementById("th_newCert");
      const msg = document.getElementById("th_certMsg");
      const name = (input.value || "").trim();

      msg.textContent = "";
      if (!name) { msg.textContent = "Digite um nome."; msg.style.color = "var(--bad)"; return; }

      const opts = loadCertOptions();
      const exists = opts.some(x => x.toLowerCase() === name.toLowerCase());
      if (exists) { msg.textContent = "Já existe."; msg.style.color = "var(--bad)"; return; }

      opts.push(name);
      saveCertOptions(opts);

      input.value = "";
      msg.textContent = "Adicionada.";
      msg.style.color = "var(--ok)";

      // mantém seleção atual
      const selected = getSelectedCerts();
      renderCertCheckboxes(selected);
    }

    // wiring terapeutas
    document.getElementById("btnThNew").addEventListener("click", () => openTherapistForm(null));
    document.getElementById("btnThCancel").addEventListener("click", cancelTherapistForm);
    document.getElementById("btnThSave").addEventListener("click", saveTherapist);
    document.getElementById("btnAddCert").addEventListener("click", addCertificationOption);

    document.getElementById("th_filter_status").addEventListener("change", renderTherapistsList);
    document.getElementById("th_q").addEventListener("input", renderTherapistsList);
    document.getElementById("th_hasWeeklyOff").addEventListener("change", syncDayOffEnabled);

    // ---------------------------
    // Reset
    // ---------------------------
    document.getElementById("btnReset").addEventListener("click", () => {
      if (!confirm("Tem certeza que deseja apagar todos os dados locais?")) return;
      localStorage.removeItem(REQ_KEY);
      localStorage.removeItem(TEAM_KEY);
      localStorage.removeItem(TH_KEY);
      localStorage.removeItem(CERT_KEY);
      updateKpis();
      renderList();
      renderTeam();
      renderTherapistsList();
      setView("home");
    });

    // Init
    populateUnits();
    populateTimes();
    renderCertCheckboxes(loadCertOptions()); // mostra opções mesmo antes de abrir form
    updateKpis();
    setView("home");
  </script>
</body>
</html>
