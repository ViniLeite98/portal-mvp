<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Nova Terapeuta</title>

<link rel="stylesheet" href="assets/css/style.css">
<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>

<div class="app">
  <aside id="sidebar"></aside>

  <main class="content">
    <h1>Nova Terapeuta</h1>

    <!-- DADOS PESSOAIS -->
    <div class="card">
      <h3>Dados Pessoais</h3>
      <input id="nomeCompleto" placeholder="Nome Completo">
      <input id="nomeProfissional" placeholder="Nome Profissional">
      <input id="cpf" placeholder="CPF">
      <input id="rg" placeholder="RG">
      <input type="date" id="nascimento">
      <input id="email" placeholder="Email">
    </div>

    <!-- CONTATO -->
    <div class="card">
      <h3>Contato</h3>
      <input id="telefone" placeholder="Telefone">
      <input id="telefoneEmergencia" placeholder="Contato Emergência">
    </div>

    <!-- ENDEREÇO -->
    <div class="card">
      <h3>Endereço</h3>
      <input id="cep" placeholder="CEP">
      <input id="rua" placeholder="Rua">
      <input id="numero" placeholder="Número">
      <input id="bairro" placeholder="Bairro">
      <input id="cidade" placeholder="Cidade">
      <input id="uf" placeholder="UF">
    </div>

    <!-- FUNCIONAL -->
    <div class="card">
      <h3>Dados Funcionais</h3>
      <select id="temFolga">
        <option>Sim</option>
        <option>Não</option>
      </select>
      <input id="diaFolga" placeholder="Dia da Folga">
      <input type="time" id="horaEntrada">
      <input type="time" id="horaSaida">
      <input type="date" id="dataInicio">
      <select id="status">
        <option>Ativo</option>
        <option>Inativo</option>
      </select>
    </div>

    <br>
    <button onclick="salvar()">Salvar</button>
  </main>
</div>

<script src="assets/sidebar/sidebar.js"></script>

<script>
const SUPABASE_URL = "https://rymehgsoarjeecuwyhny.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTc0ODUsImV4cCI6MjA4NjIzMzQ4NX0.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

document.addEventListener("DOMContentLoaded", carregarEdicao);

async function carregarEdicao() {
  const cpfEdit = localStorage.getItem("editarTerapeutaCPF");
  if (!cpfEdit) return;

  const { data, error } = await supabaseClient
    .from("terapeutas")
    .select("*")
    .eq("cpf", cpfEdit)
    .single();

  if (error || !data) {
    console.error(error);
    return;
  }

  nomeCompleto.value = data.nome_completo || "";
  nomeProfissional.value = data.nome_profissional || "";
  cpf.value = data.cpf || "";
  rg.value = data.rg || "";
  nascimento.value = data.data_nascimento || "";
  email.value = data.email || "";
  telefone.value = data.telefone || "";
  telefoneEmergencia.value = data.telefone_emergencia || "";

  cep.value = data.cep || "";
  rua.value = data.rua || "";
  numero.value = data.numero || "";
  bairro.value = data.bairro || "";
  cidade.value = data.cidade || "";
  uf.value = data.uf || "";

  temFolga.value = data.tem_folga || "Sim";
  diaFolga.value = data.dia_folga || "";
  horaEntrada.value = data.hora_entrada || "";
  horaSaida.value = data.hora_saida || "";
  dataInicio.value = data.data_inicio || "";
  status.value = data.status || "Ativo";

  cpf.disabled = true;
}

async function salvar() {
  const cpfEdit = localStorage.getItem("editarTerapeutaCPF");

  const payload = {
    nome_completo: nomeCompleto.value,
    nome_profissional: nomeProfissional.value,
    cpf: cpf.value,
    rg: rg.value,
    data_nascimento: nascimento.value,
    email: email.value,
    telefone: telefone.value,
    telefone_emergencia: telefoneEmergencia.value,
    cep: cep.value,
    rua: rua.value,
    numero: numero.value,
    bairro: bairro.value,
    cidade: cidade.value,
    uf: uf.value,
    tem_folga: temFolga.value,
    dia_folga: diaFolga.value,
    hora_entrada: horaEntrada.value,
    hora_saida: horaSaida.value,
    data_inicio: dataInicio.value,
    status: status.value
  };

  let result;

  if (cpfEdit) {
    result = await supabaseClient
      .from("terapeutas")
      .update(payload)
      .eq("cpf", cpfEdit);
  } else {
    result = await supabaseClient
      .from("terapeutas")
      .insert([payload]);
  }

  if (result.error) {
    alert("Erro ao salvar");
    console.error(result.error);
    return;
  }

  localStorage.removeItem("editarTerapeutaCPF");
  alert("Salvo com sucesso");
  location.href = "equipe.html";
}
</script>

</body>
</html>
