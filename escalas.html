<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Escalas | Hara Spa</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:#f5f7fb;
}

.app{
  display:flex;
  min-height:100vh;
}

#sidebar{
  width:260px;
  flex-shrink:0;
}

.content{
  flex:1;
  padding:30px;
  font-size:14px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.card{
  background:#fff;
  border-radius:18px;
  padding:20px;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
}

.layout{
  display:grid;
  grid-template-columns:2.2fr 1.4fr;
  gap:20px;
  margin-top:20px;
}

.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}

.weekdays{
  margin-top:16px;
}

.weekdays div{
  text-align:center;
  font-weight:600;
  font-size:13px;
}

.day{
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  min-height:90px;
  transition:.2s;
}

.day:hover{ transform:translateY(-2px); }

.day-number{ font-weight:700; }

.day-domingo{
  background:#f3f4f6;
  color:#9ca3af;
  cursor:default;
}

.day-verde{ background:#dcfce7; border-color:#22c55e; }
.day-amarelo{ background:#fef9c3; border-color:#eab308; }
.day-vermelho{ background:#fee2e2; border-color:#ef4444; }

.section-title{ margin-top:20px; font-weight:700; }

.detail-item{
  padding:8px 0;
  border-bottom:1px solid #e5e7eb;
}

.badge-red{
  background:#fee2e2;
  color:#991b1b;
  padding:2px 6px;
  border-radius:6px;
  font-size:11px;
  margin-left:6px;
}
</style>
</head>

<body>

<div class="app">

<aside id="sidebar"></aside>

<main class="content">

<div class="header">
<h1>Escalas</h1>
<input type="date" id="dataSelecionada">
</div>

<div class="layout">

<div class="card">
<h3>Calendário</h3>

<div class="calendar weekdays">
<div>Dom</div><div>Seg</div><div>Ter</div>
<div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
</div>

<div class="calendar" id="calendar"></div>
</div>

<div class="card">
<h3 id="tituloDia">Selecione um dia</h3>
<div id="detalhesDia">—</div>
</div>

</div>

<div class="card" style="margin-top:20px;">
<h3>Força de Trabalho</h3>
<canvas id="graficoDia" height="120"></canvas>
</div>

</main>
</div>

<script src="assets/sidebar/sidebar.js"></script>

<script>
const supabaseClient = supabase.createClient(
"https://rymehgsoarjeecuwyhny.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTc0ODUsImV4cCI6MjA4NjIzMzQ4NX0.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec"
);

let terapeutas=[];
let solicitacoes=[];
let chartDia=null;

let hoje=new Date();
let ano=hoje.getFullYear();
let mes=hoje.getMonth();

document.getElementById("dataSelecionada").valueAsDate=hoje;

document.getElementById("dataSelecionada").addEventListener("change",e=>{
const d=new Date(e.target.value);
ano=d.getFullYear();
mes=d.getMonth();
renderCalendar();
});

function diaSemana(date){
return ["domingo","segunda","terça","quarta","quinta","sexta","sábado"][date.getDay()];
}

function folgaSemanal(t,data){
if(!t.tem_folga||!t.dia_folga)return false;
return t.tem_folga==="Sim"&&
diaSemana(data)===t.dia_folga.toLowerCase();
}

function folgaAprovada(t,data){
return solicitacoes.some(s=>
s.status==="Aprovado"&&
s.terapeuta_cpf===t.cpf&&
data>=new Date(s.data_inicio)&&
data<=new Date(s.data_fim)
);
}

async function carregarDados(){
const {data:dadosTerapeutas}=await supabaseClient
.from("terapeutas")
.select("*")
.eq("status","Ativo");

const {data:dadosSolicitacoes}=await supabaseClient
.from("solicitacoes")
.select("*")
.eq("status","Aprovado");

terapeutas=dadosTerapeutas||[];
solicitacoes=dadosSolicitacoes||[];
renderCalendar();
}

function renderCalendar(){
const calendar=document.getElementById("calendar");
calendar.innerHTML="";

const primeiroDia=new Date(ano,mes,1).getDay();
const totalDias=new Date(ano,mes+1,0).getDate();

for(let i=0;i<primeiroDia;i++){
calendar.appendChild(document.createElement("div"));
}

for(let d=1;d<=totalDias;d++){
const dataDia=new Date(ano,mes,d);
const diaSemanaNumero=dataDia.getDay();
const div=document.createElement("div");
div.className="day";

if(diaSemanaNumero===0){
div.classList.add("day-domingo");
div.innerHTML=`<div class="day-number">${d}</div><small>Fechado</small>`;
calendar.appendChild(div);
continue;
}

const disponiveis=terapeutas.filter(t=>
t.hora_entrada&&t.hora_saida&&
!folgaSemanal(t,dataDia)&&
!folgaAprovada(t,dataDia)
);

const total=terapeutas.length;
const ausentes=total-disponiveis.length;

if(ausentes>=4)div.classList.add("day-vermelho");
else if(ausentes>=2)div.classList.add("day-amarelo");
else if(ausentes===0)div.classList.add("day-verde");

div.innerHTML=`<div class="day-number">${d}</div>
<small>${disponiveis.length} terapeutas</small>`;

div.onclick=()=>mostrarDia(d);
calendar.appendChild(div);
}
}

carregarDados();
</script>

</body>
</html>
