<script>
const supabaseClient = supabase.createClient(
  "https://rymehgsoarjeecuwyhny.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTc0ODUsImV4cCI6MjA4NjIzMzQ4NX0.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec"
);

let paginaAtual = 1;
const limite = 10;
let totalRegistros = 0;
let idEditando = null;

async function carregarSelects(){

  const { data: terapeutas } = await supabaseClient
    .from("terapeutas")
    .select("cpf,nome_profissional")
    .order("nome_profissional");

  const selectTerapeuta = document.getElementById("cpf_terapeuta");
  selectTerapeuta.innerHTML = "";

  terapeutas.forEach(t=>{
    selectTerapeuta.innerHTML += `
      <option value="${t.cpf}">
        ${t.nome_profissional} (${t.cpf})
      </option>
    `;
  });

  const { data: certificacoes } = await supabaseClient
    .from("certificacoes")
    .select("*")
    .order("nome");

  const selectCert = document.getElementById("certificacao_id");
  selectCert.innerHTML = "";

  certificacoes.forEach(c=>{
    selectCert.innerHTML += `
      <option value="${c.id}">
        ${c.nome}
      </option>
    `;
  });
}

async function carregarLista(){

  const inicio = (paginaAtual - 1) * limite;
  const fim = inicio + limite - 1;

  const { data, error, count } = await supabaseClient
    .from("terapeuta_certificacoes")
    .select(`
      id,
      data_obtencao,
      terapeutas(nome_profissional),
      certificacoes(nome)
    `, { count: "exact" })
    .range(inicio, fim);

  if(error){
    alert(error.message);
    return;
  }

  totalRegistros = count;

  const tbody = document.getElementById("lista");
  tbody.innerHTML = "";

  data.forEach(item=>{
    tbody.innerHTML += `
      <tr>
        <td>${item.terapeutas?.nome_profissional || ""}</td>
        <td>${item.certificacoes?.nome || ""}</td>
        <td>${item.data_obtencao || ""}</td>
        <td>
          <button onclick="editar('${item.id}','${item.data_obtencao || ""}')">Editar</button>
          <button class="excluir" onclick="excluir('${item.id}')">Excluir</button>
        </td>
      </tr>
    `;
  });

  atualizarPaginacao();
}

function atualizarPaginacao(){
  const totalPaginas = Math.ceil(totalRegistros / limite);

  if(!document.getElementById("paginacao")){
    const div = document.createElement("div");
    div.id = "paginacao";
    div.style.marginTop = "15px";
    div.style.display = "flex";
    div.style.justifyContent = "space-between";
    div.innerHTML = `
      <button onclick="paginaAnterior()" id="btnAnterior">Anterior</button>
      <span id="infoPagina"></span>
      <button onclick="proximaPagina()" id="btnProximo">Próxima</button>
    `;
    document.querySelector(".content").appendChild(div);
  }

  document.getElementById("infoPagina").innerText =
    `Página ${paginaAtual} de ${totalPaginas}`;

  document.getElementById("btnAnterior").disabled = paginaAtual === 1;
  document.getElementById("btnProximo").disabled = paginaAtual === totalPaginas;
}

function proximaPagina(){
  paginaAtual++;
  carregarLista();
}

function paginaAnterior(){
  paginaAtual--;
  carregarLista();
}

function editar(id, data){
  idEditando = id;

  document.getElementById("data_obtencao").value = data || "";
  document.getElementById("cpf_terapeuta").disabled = true;
  document.getElementById("certificacao_id").disabled = true;
}

async function vincular(){

  if(idEditando){
    // modo edição
    const { error } = await supabaseClient
      .from("terapeuta_certificacoes")
      .update({
        data_obtencao: document.getElementById("data_obtencao").value || null
      })
      .eq("id", idEditando);

    if(error){
      alert(error.message);
      return;
    }

    idEditando = null;
    document.getElementById("cpf_terapeuta").disabled = false;
    document.getElementById("certificacao_id").disabled = false;
    document.getElementById("data_obtencao").value = "";
    carregarLista();
    return;
  }

  // modo inserção
  const payload = {
    cpf_terapeuta: document.getElementById("cpf_terapeuta").value,
    certificacao_id: document.getElementById("certificacao_id").value,
    data_obtencao: document.getElementById("data_obtencao").value || null
  };

  const { error } = await supabaseClient
    .from("terapeuta_certificacoes")
    .insert(payload);

  if(error){
    alert(error.message);
    return;
  }

  document.getElementById("data_obtencao").value = "";
  carregarLista();
}

async function excluir(id){

  const { error } = await supabaseClient
    .from("terapeuta_certificacoes")
    .delete()
    .eq("id", id);

  if(error){
    alert(error.message);
    return;
  }

  carregarLista();
}

carregarSelects();
carregarLista();
</script>
