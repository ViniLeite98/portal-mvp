<script>
const SUPABASE_URL = "https://rymehgsoarjeecuwyhny.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTc0ODUsImV4cCI6MjA4NjIzMzQ4NX0.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* =====================
   EQUIPE ATIVA
===================== */
async function carregarEquipe() {
  const { data } = await supabaseClient
    .from("terapeutas")
    .select("cpf")
    .eq("status", "Ativo");

  document.getElementById("total-ativas").innerText = data?.length || 0;
}

/* =====================
   FORÇA DE TRABALHO (CORRETO)
===================== */
async function carregarForcaTrabalho() {

  const { data } = await supabaseClient
    .from("terapeutas")
    .select("hora_entrada, hora_saida")
    .eq("status", "Ativo");

  // Inicializa horas 09 → 21
  const horas = {};
  for (let h = 9; h <= 21; h++) horas[h] = 0;

  data?.forEach(t => {
    if (!t.hora_entrada || !t.hora_saida) return;

    const [hi, mi] = t.hora_entrada.split(":").map(Number);
    const [hf, mf] = t.hora_saida.split(":").map(Number);

    const inicio = hi + mi / 60;
    const fim = hf + mf / 60;

    for (let h = 9; h <= 21; h++) {
      if (inicio <= h && h < fim) {
        horas[h]++;
      }
    }
  });

  const container = document.getElementById("workforce-bars");
  container.innerHTML = "";

  Object.keys(horas).forEach(h => {
    const qtd = horas[h];
    container.innerHTML += `
      <div class="bar-wrap">
        <div class="qtd">${qtd}</div>
        <div class="bar" style="height:${qtd * 18}px"></div>
        <div class="hour">${h}:00</div>
      </div>
    `;
  });
}

/* =====================
   CARGA HORÁRIA (CORRETA)
===================== */
async function carregarCargaHoraria() {

  const { data } = await supabaseClient
    .from("terapeutas")
    .select("nome_profissi, hora_entrada, hora_saida")
    .eq("status", "Ativo");

  const lista = [];

  data?.forEach(t => {
    if (!t.hora_entrada || !t.hora_saida) return;

    const [hi, mi] = t.hora_entrada.split(":").map(Number);
    const [hf, mf] = t.hora_saida.split(":").map(Number);

    const totalMinutos = (hf * 60 + mf) - (hi * 60 + mi);
    if (totalMinutos <= 0) return;

    const horas = Math.floor(totalMinutos / 60);
    const minutos = totalMinutos % 60;

    lista.push({
      nome: t.nome_profissi,
      minutos: totalMinutos,
      texto: `${horas}:${minutos.toString().padStart(2, "0")}`
    });
  });

  lista.sort((a, b) => b.minutos - a.minutos);

  const box = document.getElementById("carga-horaria");
  box.innerHTML = "";

  if (!lista.length) {
    box.innerHTML = "<p>Sem dados válidos</p>";
    return;
  }

  lista.slice(0, 3).forEach(t => {
    box.innerHTML += `
      <p>
        ${t.nome}
        <span>${t.texto}h</span>
      </p>
    `;
  });
}

/* INIT */
carregarEquipe();
carregarForcaTrabalho();
carregarCargaHoraria();
</script>
