<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal MVP • Governança</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Portal MVP</h1>
          <div class="muted">Governança de dados (MVP)</div>
        </div>
      </div>
      <div class="kpi">
        <span class="pill">Total: <strong id="kpiTotal">0</strong></span>
        <span class="pill">Abertas: <strong id="kpiOpen">0</strong></span>
        <span class="pill">Aprovadas: <strong id="kpiApproved">0</strong></span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- MENU -->
    <section class="card">
      <div class="hd"><div class="muted">Navegação</div></div>
      <div class="bd">
<div class="nav">
  <a class="btn" href="./index.html">Início</a>
  <a class="btn" href="./materiais.html">Materiais</a>
  <a class="btn" href="./solicitacoes.html">Solicitações</a>
  <a class="btn" href="./equipe.html">Equipe</a>
  <a class="btn" href="./terapeutas.html">Terapeutas</a>
  <a class="btn primary" href="./governanca.html">Governança</a>
</div>

      </div>
      <div class="ft">
        <button class="btn danger small" id="btnReset">Zerar dados</button>
        <span class="note">Somente local</span>
      </div>
    </section>

    <!-- CONTEÚDO -->
    <section class="card">
      <div class="hd">
        <h2 style="margin:0;font-size:18px">Governança de dados</h2>
        <div class="muted">Configuração de responsabilidades e políticas (LocalStorage).</div>
      </div>

      <div class="bd">
        <div class="row2">
          <div>
            <label for="owner">Data Owner (responsável)</label>
            <input id="owner" placeholder="Ex.: Coordenação" />
          </div>
          <div>
            <label for="steward">Data Steward (operacional)</label>
            <input id="steward" placeholder="Ex.: Administrativo" />
          </div>
        </div>

        <div class="sep"></div>

        <div class="row2">
          <div>
            <label for="classification">Classificação dos dados</label>
            <select id="classification">
              <option value="Público">Público</option>
              <option value="Interno" selected>Interno</option>
              <option value="Confidencial">Confidencial</option>
              <option value="Sensível (LGPD)">Sensível (LGPD)</option>
            </select>
          </div>
          <div>
            <label for="retention">Retenção (dias)</label>
            <input id="retention" type="number" min="0" placeholder="Ex.: 365" />
          </div>
        </div>

        <div class="sep"></div>

        <div class="row2">
          <div>
            <label for="backup">Backups</label>
            <select id="backup">
              <option value="Não definido">Não definido</option>
              <option value="Diário">Diário</option>
              <option value="Semanal">Semanal</option>
              <option value="Mensal">Mensal</option>
            </select>
          </div>
          <div>
            <label for="incident">Contato para incidente</label>
            <input id="incident" type="email" placeholder="Ex.: suporte@empresa.com" />
          </div>
        </div>

        <div class="sep"></div>

        <div>
          <label for="access">Política de acesso (texto)</label>
          <textarea id="access" placeholder="Quem pode acessar o quê, critérios de concessão, revisões..."></textarea>
        </div>

        <div class="sep"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button class="btn primary" type="button" id="btnSaveGov">Salvar política</button>
          <span class="note" id="govMsg"></span>
        </div>

        <div class="sep"></div>

        <h3 style="margin:0 0 8px 0;font-size:18px">Registro de alterações</h3>
        <div class="muted" style="margin-bottom:10px">Histórico local das mudanças.</div>

        <table><tbody id="govLogRows"></tbody></table>
        <div class="note" id="govLogEmpty"></div>
      </div>
    </section>
  </div>
</main>

<script src="./app.js?v=2"></script>
<script>
  const { loadJSON, saveJSON, nowISO, escapeHtml, GOV_KEY, GOV_LOG_KEY, renderKpis, wireResetButton } = window.App;

  renderKpis();
  wireResetButton();

  const $ = (id) => document.getElementById(id);

  function loadPolicy(){
    const p = loadJSON(GOV_KEY, {
      owner: "", steward: "", classification: "Interno", retention: "", backup: "Não definido",
      incident: "", access: "", updated_at: ""
    });

    $("owner").value = p.owner || "";
    $("steward").value = p.steward || "";
    $("classification").value = p.classification || "Interno";
    $("retention").value = p.retention || "";
    $("backup").value = p.backup || "Não definido";
    $("incident").value = p.incident || "";
    $("access").value = p.access || "";
  }

  function renderLog(){
    const rows = $("govLogRows");
    const empty = $("govLogEmpty");
    const log = loadJSON(GOV_LOG_KEY, []);
    rows.innerHTML = "";

    if (!log.length){
      empty.textContent = "Sem alterações registradas.";
      return;
    }
    empty.textContent = "";

    for (const e of log){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="font-weight:750">${escapeHtml(e.at || "")}</div>
          <div class="muted" style="margin-top:6px">${escapeHtml(e.summary || "")}</div>
        </td>
      `;
      rows.appendChild(tr);
    }
  }

  function savePolicy(){
    const p = {
      owner: $("owner").value.trim(),
      steward: $("steward").value.trim(),
      classification: $("classification").value,
      retention: $("retention").value,
      backup: $("backup").value,
      incident: $("incident").value.trim(),
      access: $("access").value.trim(),
      updated_at: nowISO()
    };
    saveJSON(GOV_KEY, p);

    const log = loadJSON(GOV_LOG_KEY, []);
    log.unshift({
      at: new Date().toLocaleString(),
      summary: `Política atualizada • Classificação: ${p.classification} • Backup: ${p.backup} • Retenção: ${p.retention || "-"} dias`
    });
    saveJSON(GOV_LOG_KEY, log.slice(0, 50)); // limita 50

    $("govMsg").textContent = "Salvo.";
    renderLog();
  }

  $("btnSaveGov").addEventListener("click", savePolicy);

  loadPolicy();
  renderLog();
</script>
</body>
</html>
