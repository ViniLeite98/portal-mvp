<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal MVP • Terapeutas</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Portal MVP</h1>
            <div class="muted">Terapeutas</div>
          </div>
        </div>

        <div class="kpi">
          <span class="pill">Total: <strong id="kpiTotal">0</strong></span>
          <span class="pill">Abertas: <strong id="kpiOpen">0</strong></span>
          <span class="pill">Aprovadas: <strong id="kpiApproved">0</strong></span>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="hd"><div class="muted">Navegação</div></div>
        <div class="bd">
          <div class="nav" id="nav"></div>
        </div>
        <div class="ft">
          <button class="btn danger small" id="btnReset">Zerar dados</button>
          <span class="note">Somente local</span>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <h2 style="margin:0;font-size:18px" id="th_title">Terapeutas</h2>
          <div class="muted" id="th_subtitle">Lista + criar/editar (campos completos) + certificações dinâmicas.</div>
        </div>

        <div class="bd">
          <!-- LISTA -->
          <div id="th_list_block">
            <div class="row2">
              <div>
                <label for="th_filter_status">Filtrar por status</label>
                <select id="th_filter_status">
                  <option value="ALL">Todos</option>
                  <option value="ACTIVE">Ativo</option>
                  <option value="INACTIVE">Inativo</option>
                </select>
              </div>
              <div>
                <label for="th_q">Buscar</label>
                <input id="th_q" placeholder="Buscar por nome, unidade, CPF, e-mail..." />
              </div>
            </div>

            <div class="sep"></div>
            <button class="btn primary" id="btnThNew">Nova terapeuta</button>

            <div class="sep"></div>

            <table>
              <tbody id="th_rows"></tbody>
            </table>

            <div class="note" id="th_emptyMsg"></div>
          </div>

          <!-- FORM -->
          <div id="th_form_block" style="display:none">
            <div class="note" style="margin-bottom:10px">Preencha os dados da terapeuta</div>

            <div class="row2">
              <div>
                <label for="th_fullName">Nome Completo *</label>
                <input id="th_fullName" />
              </div>
              <div>
                <label for="th_profName">Nome profissional *</label>
                <input id="th_profName" />
              </div>
            </div>

            <div class="row4">
              <div>
                <label for="th_birth">Data de Nascimento *</label>
                <input id="th_birth" type="date" />
              </div>
              <div>
                <label for="th_cpf">CPF* (11 dígitos)</label>
                <input id="th_cpf" inputmode="numeric" maxlength="11" placeholder="Somente números" />
              </div>
              <div>
                <label for="th_email">Email *</label>
                <input id="th_email" type="email" />
              </div>
              <div>
                <label for="th_unit">Unidade *</label>
                <select id="th_unit"></select>
              </div>
            </div>

            <div class="row3">
              <div>
                <label for="th_address">Endereço</label>
                <input id="th_address" />
              </div>
              <div>
                <label for="th_contact">Contato *</label>
                <input id="th_contact" inputmode="numeric" placeholder="Somente números" />
              </div>
              <div>
                <label for="th_emergency">Contato Emergência</label>
                <input id="th_emergency" inputmode="numeric" placeholder="Somente números" />
              </div>
            </div>

            <div class="row4">
              <div>
                <label for="th_pixType">Tipo de Chave Pix</label>
                <select id="th_pixType">
                  <option value="CPF">CPF</option>
                  <option value="EMAIL">E-mail</option>
                  <option value="TELEFONE">Telefone</option>
                  <option value="ALEATORIA">Aleatória</option>
                </select>
              </div>
              <div>
                <label for="th_pixKey">Chave Pix</label>
                <input id="th_pixKey" />
              </div>
              <div>
                <label for="th_hasWeeklyOff">Tem folga semanal? *</label>
                <select id="th_hasWeeklyOff">
                  <option value="SIM">Sim</option>
                  <option value="NAO">Não</option>
                </select>
              </div>
              <div>
                <label for="th_dayOff">Dia da Folga</label>
                <select id="th_dayOff">
                  <option value="">—</option>
                  <option>Segunda</option><option>Terça</option><option>Quarta</option>
                  <option>Quinta</option><option>Sexta</option><option>Sábado</option><option>Domingo</option>
                </select>
              </div>
            </div>

            <div class="row4">
              <div>
                <label for="th_startTime">Horário de Entrada *</label>
                <select id="th_startTime"></select>
              </div>
              <div>
                <label for="th_endTime">Horário de Saída *</label>
                <select id="th_endTime"></select>
              </div>
              <div>
                <label for="th_startDate">Data de Início *</label>
                <input id="th_startDate" type="date" />
              </div>
              <div>
                <label for="th_blood">Tipo Sanguíneo</label>
                <select id="th_blood">
                  <option value="">—</option>
                  <option>A+</option><option>A-</option>
                  <option>B+</option><option>B-</option>
                  <option>AB+</option><option>AB-</option>
                  <option>O+</option><option>O-</option>
                </select>
              </div>
            </div>

            <div class="row2">
              <div>
                <label>Status *</label>
                <div class="radioRow">
                  <label><input type="radio" name="th_status" value="ACTIVE" checked /> Ativo</label>
                  <label><input type="radio" name="th_status" value="INACTIVE" /> Inativo</label>
                </div>
              </div>
              <div>
                <label>&nbsp;</label>
                <div class="note">Campos com * são obrigatórios.</div>
              </div>
            </div>

            <div class="sep"></div>

            <h3 style="margin:0 0 8px 0;font-size:18px">Certificações</h3>

            <div class="row2">
              <div>
                <label for="th_newCert">Incluir nova certificação</label>
                <input id="th_newCert" placeholder="Ex.: Drenagem Linfática" />
              </div>
              <div style="display:flex;gap:10px;align-items:flex-end">
                <button class="btn" id="btnAddCert">Adicionar certificação</button>
                <span class="note" id="th_certMsg"></span>
              </div>
            </div>

            <div class="checkboxGrid" id="th_certsGrid"></div>

            <div class="sep"></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnThSave">Salvar</button>
              <button class="btn" id="btnThCancel">Cancelar</button>
              <span class="note" id="th_formMsg"></span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script src="./app.js"></script>
  <script>
    const {
      renderNav, renderKpis, wireResetButton,
      loadJSON, saveJSON, TH_KEY, CERT_KEY, UNIT_KEY,
      uid, nowISO, fmt, escapeHtml, onlyDigits
    } = window.App;

    renderNav("therapists");
    renderKpis();
    wireResetButton();

    // Defaults (usados só se ainda não existir cadastro mestre no Governança)
    const DEFAULT_UNITS = ["Unidade 1","Unidade 2","Unidade 3"];
    const DEFAULT_CERTS = ["Massagem Nuru","Massagem Vivência","Podolatria","Massagem Casais","Massagem Feminina"];

    let editingId = null;

    function loadUnits(){
      const v = loadJSON(UNIT_KEY, null);
      return Array.isArray(v) && v.length ? v : DEFAULT_UNITS.slice();
    }

    function loadCertOptions(){
      const v = loadJSON(CERT_KEY, null);
      return Array.isArray(v) && v.length ? v : DEFAULT_CERTS.slice();
    }
    function saveCertOptions(items){
      saveJSON(CERT_KEY, items);
    }

    function populateUnits(selectedValue){
      const sel = document.getElementById("th_unit");
      const units = loadUnits();
      sel.innerHTML = "";

      for (const u of units){
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        sel.appendChild(opt);
      }

      if (selectedValue && units.includes(selectedValue)) sel.value = selectedValue;
      else sel.value = units[0] || "";
    }

    function populateTimes(){
      const start = document.getElementById("th_startTime");
      const end = document.getElementById("th_endTime");
      start.innerHTML = "";
      end.innerHTML = "";
      for (let h=6; h<=23; h++){
        for (let m=0; m<60; m+=30){
          const t = String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
          const o1 = document.createElement("option"); o1.value=t; o1.textC
