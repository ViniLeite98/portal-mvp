<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/assets/js/supabase.js"></script>

<script>

const supabase = window.supabaseClient;

// ================= SIDEBAR =================
fetch('/assets/sidebar/sidebar.html')
  .then(res => res.text())
  .then(data => {
    document.getElementById('sidebar').innerHTML = data
  })

// ================= CARREGAR EQUIPE =================
async function carregarEquipe() {
  const { data, error } = await supabase
    .from('equipe')
    .select('id, nome, cpf')

  if(error){
    console.error(error)
    return
  }

  const select = document.getElementById("selectEquipe")
  select.innerHTML = '<option value="">Selecione CPF da Atendente</option>'

  data.forEach(e => {
    select.innerHTML += `
      <option value="${e.id}">
        ${e.cpf} - ${e.nome}
      </option>
    `
  })
}

// ================= CARREGAR CERTIFICACOES =================
async function carregarCertificacoes() {
  const { data, error } = await supabase
    .from('certificacoes')
    .select('*')

  if(error){
    console.error(error)
    return
  }

  const select = document.getElementById("selectCertificacao")
  select.innerHTML = '<option value="">Selecione Certificação</option>'

  data.forEach(c => {
    select.innerHTML += `
      <option value="${c.id}">
        ${c.nome}
      </option>
    `
  })
}

// ================= VINCULAR =================
async function vincular() {
  const equipe_id = document.getElementById("selectEquipe").value
  const certificacao_id = document.getElementById("selectCertificacao").value

  if (!equipe_id || !certificacao_id) {
    alert("Selecione os dois campos.")
    return
  }

  const { error } = await supabase
    .from('equipe_certificacoes')
    .insert([{ equipe_id, certificacao_id }])

  if (error) {
    alert("Já vinculada.")
    return
  }

  carregarTabela()
}

// ================= LISTAR =================
async function carregarTabela() {
  const { data, error } = await supabase
    .from('equipe_certificacoes')
    .select(`
      id,
      equipe:equipe_id (nome, cpf),
      certificacao:certificacao_id (nome)
    `)

  if(error){
    console.error(error)
    return
  }

  const tbody = document.getElementById("tabelaCertificacoes")
  tbody.innerHTML = ""

  data.forEach(item => {
    tbody.innerHTML += `
      <tr>
        <td>${item.equipe?.nome}</td>
        <td>${item.equipe?.cpf}</td>
        <td>${item.certificacao?.nome}</td>
        <td>
          <button onclick="remover('${item.id}')">Remover</button>
        </td>
      </tr>
    `
  })
}

// ================= REMOVER =================
async function remover(id) {
  await supabase
    .from('equipe_certificacoes')
    .delete()
    .eq('id', id)

  carregarTabela()
}

// ================= INIT =================
carregarEquipe()
carregarCertificacoes()
carregarTabela()

</script>
