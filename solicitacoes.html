<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gerenciar Solicitações | Hara Spa</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<style>
body { margin:0; font-family:'Segoe UI'; background:#f5f7fb; }
.app { display:flex; min-height:100vh; }
.content { flex:1; padding:40px; margin-left:260px; }

.card {
  background:#fff;
  border-radius:20px;
  padding:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}

th, td {
  padding:10px;
  border-bottom:1px solid #eee;
  font-size:14px;
  text-align:left;
}

button {
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
}

.btn-aprovar { background:#16a34a; color:#fff; }
.btn-reprovar { background:#dc2626; color:#fff; }

.status-pendente { color:#d97706; font-weight:bold; }
.status-aprovado { color:#16a34a; font-weight:bold; }
.status-reprovado { color:#dc2626; font-weight:bold; }

.login-box {
  width:300px;
  margin:150px auto;
  background:#fff;
  padding:30px;
  border-radius:20px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  text-align:center;
}

input {
  padding:8px;
  width:100%;
  margin-bottom:15px;
  border-radius:6px;
  border:1px solid #ddd;
}
</style>
</head>
<body>

<div id="loginScreen" class="login-box">
  <h2>Acesso Restrito</h2>
  <input type="password" id="senha" placeholder="Digite a senha">
  <button onclick="validarSenha()">Entrar</button>
</div>

<div id="painel" style="display:none">
  <div class="app">
    <aside id="sidebar"></aside>

    <main class="content">
      <div class="card">
        <h2>Gerenciar Solicitações</h2>

        <table>
          <thead>
            <tr>
              <th>Terapeuta</th>
              <th>Tipo</th>
              <th>Período</th>
              <th>Status</th>
              <th>Criado em</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="lista"></tbody>
        </table>
      </div>
    </main>
  </div>
</div>

<script src="assets/sidebar/sidebar.js"></script>

<script>
const supabaseClient = supabase.createClient(
  "https://rymehgsoarjeecuwyhny.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTc0ODUsImV4cCI6MjA4NjIzMzQ4NX0.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec"
);

/* ========================
   SENHA
======================== */
function validarSenha() {
  const senha = document.getElementById("senha").value;

  if (senha === "2026") {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("painel").style.display = "block";
    carregarSolicitacoes();
  } else {
    alert("Senha incorreta");
  }
}

/* ========================
   CARREGAR SOLICITAÇÕES
======================== */
async function carregarSolicitacoes() {

  const { data, error } = await supabaseClient
    .from("solicitacoes")
    .select("*")
    .order("created_at", { ascending:false });

  if (error) {
    console.error(error);
    return;
  }

  const tbody = document.getElementById("lista");
  tbody.innerHTML = "";

  data.forEach(s => {

    const dataCriacao = new Date(s.created_at);
    const dataFormatada = dataCriacao.toLocaleString("pt-BR", {
      timeZone: "America/Sao_Paulo"
    });

    let statusClass = "";
    if (s.status === "Pendente") statusClass = "status-pendente";
    if (s.status === "Aprovado") statusClass = "status-aprovado";
    if (s.status === "Reprovado") statusClass = "status-reprovado";

    tbody.innerHTML += `
      <tr>
        <td>${s.terapeuta_cpf}</td>
        <td>${s.tipo}</td>
        <td>${s.data_inicio} → ${s.data_fim}</td>
        <td class="${statusClass}">${s.status}</td>
        <td>${dataFormatada}</td>
        <td>
          <button class="btn-aprovar" onclick="alterarStatus(${s.id}, 'Aprovado')">Aprovar</button>
          <button class="btn-reprovar" onclick="alterarStatus(${s.id}, 'Reprovado')">Reprovar</button>
        </td>
      </tr>
    `;
  });

}

/* ========================
   ALTERAR STATUS
======================== */
async function alterarStatus(id, novoStatus) {

  const { error } = await supabaseClient
    .from("solicitacoes")
    .update({ status: novoStatus })
    .eq("id", id);

  if (error) {
    console.error(error);
    alert("Erro ao atualizar status");
    return;
  }

  carregarSolicitacoes();
}
</script>

</body>
</html>
