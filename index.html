<script>
// ===============================
// LOAD STORAGE
// ===============================
var terapeutas = JSON.parse(localStorage.getItem("terapeutas") || "[]");
var solicitacoes = JSON.parse(localStorage.getItem("solicitacoes") || "[]");

// ===============================
// KPI EQUIPE
// ===============================
var ativas = terapeutas.filter(function(t){
  return t.status !== "Inativo";
});
document.getElementById("kpiEquipe").innerText = ativas.length;

// ===============================
// DIAS FOLGADOS (CORRIGIDO)
// ===============================
var dias = {};

solicitacoes.forEach(function(s){
  if (s.status !== "Aprovado") return;
  if (!s.dataInicio || !s.dataFim) return;

  var ini = new Date(s.dataInicio);
  var fim = new Date(s.dataFim);
  if (isNaN(ini) || isNaN(fim)) return;

  var d = Math.floor((fim - ini) / 86400000) + 1;
  if (d <= 0) return;

  var nome = s.terapeutaNome || "—";
  dias[nome] = (dias[nome] || 0) + d;
});

var folgaHTML = "";
for (var n in dias) {
  folgaHTML += "<div><b>" + n + "</b>: " + dias[n] + " dias</div>";
}
document.getElementById("diasFolga").innerHTML = folgaHTML || "—";

// ===============================
// FORÇA DE TRABALHO
// ===============================
var horas = [];
for (var h = 9; h <= 22; h++) horas.push(h);

var contagem = horas.map(function(hora){
  return ativas.filter(function(t){
    if (!t.horaEntrada || !t.horaSaida) return false;

    var he = parseInt(t.horaEntrada.split(":")[0],10);
    var hs = parseInt(t.horaSaida.split(":")[0],10);
    if (isNaN(he) || isNaN(hs)) return false;

    return hora >= he && hora < hs;
  }).length;
});

var ctx = document.getElementById("grafico");
if (ctx) {
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: horas.map(h => h + ":00"),
      datasets: [{
        label: "Terapeutas ativas",
        data: contagem,
        backgroundColor: "#3b82f6"
      }]
    },
    options: {
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });
}

// ===============================
// CARGA HORÁRIA
// ===============================
var carga = {};

ativas.forEach(function(t){
  if (!t.horaEntrada || !t.horaSaida) return;

  var he = parseInt(t.horaEntrada.split(":")[0],10);
  var hs = parseInt(t.horaSaida.split(":")[0],10);
  if (isNaN(he) || isNaN(hs) || hs <= he) return;

  var nome = t.nomeProfissional || t.nomeCompleto || "—";
  carga[nome] = (carga[nome] || 0) + (hs - he);
});

var rankHTML = "";
for (var nome in carga) {
  rankHTML += "<div>" + nome + ": " + carga[nome] + "h</div>";
}
document.getElementById("rankHoras").innerHTML = rankHTML || "—";
</script>
