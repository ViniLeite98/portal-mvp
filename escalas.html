<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Escalas | Hara Spa</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:#f5f7fb;
}

.app{
  display:flex;
  min-height:100vh;
}

#sidebar{
  width:260px;
  flex-shrink:0;
}

.content{
  flex:1;
  padding:40px;
  font-size:14px;
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* CARD */
.card{
  background:#fff;
  border-radius:18px;
  padding:20px;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
}

/* LAYOUT */
.layout{
  display:grid;
  grid-template-columns:2.2fr 1.4fr;
  gap:20px;
  margin-top:20px;
}

/* CALENDÁRIO */
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}

.weekdays{
  margin-top:16px;
}

.weekdays div{
  text-align:center;
  font-weight:600;
  font-size:13px;
}

.day{
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:10px;
  cursor:pointer;
  min-height:90px;
  transition:.2s;
}

.day:hover{
  transform:translateY(-2px);
}

.day-number{
  font-weight:700;
}

.day-domingo{
  background:#f3f4f6;
  color:#9ca3af;
  cursor:default;
}

.day-verde{
  background:#dcfce7;
  border-color:#22c55e;
}

.day-amarelo{
  background:#fef9c3;
  border-color:#eab308;
}

.day-vermelho{
  background:#fee2e2;
  border-color:#ef4444;
}

.section-title{
  margin-top:20px;
  font-weight:700;
}

.detail-item{
  padding:8px 0;
  border-bottom:1px solid #e5e7eb;
}

.badge-red{
  background:#fee2e2;
  color:#991b1b;
  padding:2px 6px;
  border-radius:6px;
  font-size:11px;
  margin-left:6px;
}
</style>
</head>

<body>

<div class="app">
  <aside id="sidebar"></aside>

  <main class="content">

    <div class="header">
      <h1>Escalas</h1>
      <input type="date" id="dataSelecionada">
    </div>

    <div class="layout">

      <!-- CALENDÁRIO -->
      <div class="card">
        <h3>Calendário</h3>

        <div class="calendar weekdays">
          <div>Dom</div><div>Seg</div><div>Ter</div>
          <div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
        </div>

        <div class="calendar" id="calendar"></div>
      </div>

      <!-- DETALHES -->
      <div class="card">
        <h3 id="tituloDia">Selecione um dia</h3>
        <div id="detalhesDia">—</div>
      </div>

    </div>

    <!-- FORÇA DE TRABALHO -->
    <div class="card" style="margin-top:20px;">
      <h3>Força de Trabalho</h3>
      <canvas id="graficoDia" height="120"></canvas>
    </div>

  </main>
</div>

<script src="assets/sidebar/sidebar.js"></script>

<script>
const supabaseClient = supabase.createClient(
  "https://rymehgsoarjeecuwyhny.supabase.co",
  "SUA_ANON_KEY_AQUI"
);

let terapeutas=[];
let solicitacoes=[];
let chartDia=null;

let hoje=new Date();
let ano=hoje.getFullYear();
let mes=hoje.getMonth();

document.getElementById("dataSelecionada").valueAsDate=hoje;

document.getElementById("dataSelecionada").addEventListener("change",e=>{
  const d=new Date(e.target.value);
  ano=d.getFullYear();
  mes=d.getMonth();
  renderCalendar();
});

function diaSemana(date){
  return ["domingo","segunda","terça","quarta","quinta","sexta","sábado"][date.getDay()];
}

function folgaSemanal(t,data){
  if(!t.tem_folga||!t.dia_folga) return false;
  return t.tem_folga==="Sim" &&
         diaSemana(data)===t.dia_folga.toLowerCase();
}

function folgaAprovada(t,data){
  return solicitacoes.some(s =>
    s.status==="Aprovado" &&
    s.terapeuta_cpf===t.cpf &&
    data>=new Date(s.data_inicio) &&
    data<=new Date(s.data_fim)
  );
}

async function carregarDados(){

  const { data: dadosTerapeutas } = await supabaseClient
    .from("terapeutas")
    .select("*")
    .eq("status","Ativo");

  const { data: dadosSolicitacoes } = await supabaseClient
    .from("solicitacoes")
    .select("*")
    .eq("status","Aprovado");

  terapeutas=dadosTerapeutas||[];
  solicitacoes=dadosSolicitacoes||[];

  renderCalendar();
}

function renderCalendar(){

  const calendar=document.getElementById("calendar");
  calendar.innerHTML="";

  const primeiroDia=new Date(ano,mes,1).getDay();
  const totalDias=new Date(ano,mes+1,0).getDate();

  for(let i=0;i<primeiroDia;i++){
    calendar.appendChild(document.createElement("div"));
  }

  for(let d=1;d<=totalDias;d++){

    const dataDia=new Date(ano,mes,d);
    const diaSemanaNumero=dataDia.getDay();

    const div=document.createElement("div");
    div.className="day";

    if(diaSemanaNumero===0){
      div.classList.add("day-domingo");
      div.innerHTML=`<div class="day-number">${d}</div><small>Fechado</small>`;
      calendar.appendChild(div);
      continue;
    }

    const disponiveis=terapeutas.filter(t =>
      t.hora_entrada && t.hora_saida &&
      !folgaSemanal(t,dataDia) &&
      !folgaAprovada(t,dataDia)
    );

    const total=terapeutas.length;
    const ausentes=total-disponiveis.length;

    if(ausentes>=4) div.classList.add("day-vermelho");
    else if(ausentes>=2) div.classList.add("day-amarelo");
    else if(ausentes===0) div.classList.add("day-verde");

    div.innerHTML=`<div class="day-number">${d}</div>
                   <small>${disponiveis.length} terapeutas</small>`;

    div.onclick=()=>mostrarDia(d);
    calendar.appendChild(div);
  }
}

function mostrarDia(dia){

  const data=new Date(ano,mes,dia);
  document.getElementById("tituloDia").innerText=
    `Dia ${dia}/${mes+1}/${ano}`;

  const detalhes=document.getElementById("detalhesDia");
  detalhes.innerHTML="";

  const disponiveis=terapeutas.filter(t =>
    t.hora_entrada && t.hora_saida &&
    !folgaSemanal(t,data) &&
    !folgaAprovada(t,data)
  );

  const indisponiveis=terapeutas.filter(t =>
    folgaSemanal(t,data) || folgaAprovada(t,data)
  );

  detalhes.innerHTML += `<div class="section-title">
  Disponíveis (${disponiveis.length})
  </div>`;

  disponiveis.forEach(t=>{
    detalhes.innerHTML += `
      <div class="detail-item">
        <b>${t.nome_profissional}</b><br>
        ${t.hora_entrada} – ${t.hora_saida}
      </div>`;
  });

  detalhes.innerHTML += `<div class="section-title">
  Indisponíveis (${indisponiveis.length})
  </div>`;

  indisponiveis.forEach(t=>{
    let motivo="";
    if(folgaSemanal(t,data)){
      motivo=`Folga semanal (${t.dia_folga})`;
    }
    else if(folgaAprovada(t,data)){
      motivo="Ausência aprovada";
    }

    detalhes.innerHTML += `
      <div class="detail-item">
        <b>${t.nome_profissional}</b>
        <span class="badge-red">${motivo}</span>
      </div>`;
  });

  renderForcaTrabalho(disponiveis);
}

function renderForcaTrabalho(lista){

  const horas=[];
  for(let h=9;h<=21;h++) horas.push(h);

  const contagem=horas.map(hora =>
    lista.filter(t=>{
      const he=parseInt((t.hora_entrada||"0").split(":")[0]);
      const hs=parseInt((t.hora_saida||"0").split(":")[0]);
      return hora>=he && hora<hs;
    }).length
  );

  if(chartDia) chartDia.destroy();

  chartDia=new Chart(document.getElementById("graficoDia"),{
    type:"bar",
    data:{
      labels:horas.map(h=>h+":00"),
      datasets:[{
        data:contagem,
        backgroundColor:"#2563eb",
        borderRadius:8,
        borderSkipped:false,
        barThickness:28
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{
        x:{grid:{display:false},ticks:{color:"#6b7280"}},
        y:{
          beginAtZero:true,
          ticks:{stepSize:1,color:"#6b7280"},
          grid:{color:"#f1f5f9"}
        }
      }
    }
  });
}

carregarDados();
</script>

</body>
</html>
