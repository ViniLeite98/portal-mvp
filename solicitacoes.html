<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal MVP ‚Ä¢ Solicita√ß√µes</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Portal MVP</h1>
          <div class="muted">Solicita√ß√µes ‚Ä¢ Indisponibilidade</div>
        </div>
      </div>

      <div class="kpi">
        <span class="pill">Total: <strong id="kpiTotal">0</strong></span>
        <span class="pill">Abertas: <strong id="kpiOpen">0</strong></span>
        <span class="pill">Aprovadas: <strong id="kpiApproved">0</strong></span>
        <span class="pill">Terapeutas ativas: <strong id="kpiTherapistsActive">0</strong></span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- MENU -->
    <section class="card">
      <div class="hd"><div class="muted">Navega√ß√£o</div></div>
      <div class="bd">
        <div class="nav">
          <a class="btn" href="./index.html">In√≠cio</a>
          <a class="btn" href="./materiais.html">Materiais</a>
          <a class="btn primary" href="./solicitacoes.html">Solicita√ß√µes</a>
          <a class="btn" href="./equipe.html">Equipe</a>
          <a class="btn" href="./terapeutas.html">Terapeutas</a>
          <a class="btn" href="./governanca.html">Governan√ßa</a>
        </div>
      </div>
      <div class="ft">
        <button class="btn danger small" id="btnReset" type="button">Zerar dados</button>
        <span class="note">Somente local</span>
      </div>
    </section>

    <!-- CONTE√öDO -->
    <section class="card">
      <div class="hd">
        <h2 style="margin:0;font-size:18px">Solicita√ß√µes</h2>
        <div class="muted">Nova solicita√ß√£o ‚Ä¢ Aprova√ß√µes (admin) ‚Ä¢ Gerenciar (admin)</div>
      </div>

      <div class="bd">
        <div id="jsWarn" class="note" style="display:none;color:var(--bad);margin-bottom:12px"></div>

        <!-- ABAS -->
        <div class="row2" style="grid-template-columns:repeat(3,1fr)">
          <button class="btn" id="tabNew" type="button">Nova Solicita√ß√£o</button>
          <button class="btn" id="tabApprove" type="button">Lista de aprova√ß√µes</button>
          <button class="btn" id="tabManage" type="button">Gerenciar solicita√ß√µes</button>
        </div>

        <div class="sep"></div>

        <!-- =========================
             ABA 1: NOVA SOLICITA√á√ÉO
        ========================== -->
        <div id="viewNew">
          <h3 style="margin:0 0 6px 0;font-size:18px">Nova Solicita√ß√£o</h3>
          <div class="muted" style="margin-bottom:12px">Registre uma indisponibilidade (falta, f√©rias, viagem etc.).</div>

          <div id="noCpfBox" class="note" style="display:none;margin-bottom:12px">
            Nenhum CPF encontrado em <b>Terapeutas</b>. Cadastre a terapeuta com CPF antes de solicitar.
          </div>

          <div id="newFormBox">
            <div class="row2">
              <div>
                <label for="cpfSelect">CPF (identifica√ß√£o) *</label>
                <select id="cpfSelect"></select>
              </div>
              <div>
                <label for="profissional">Profissional</label>
                <input id="profissional" disabled />
              </div>
            </div>

            <div class="sep"></div>

            <div class="row2">
              <div>
                <label for="dtInicio">Data In√≠cio *</label>
                <input id="dtInicio" type="date" />
              </div>
              <div>
                <label for="dtFim">Data Fim *</label>
                <input id="dtFim" type="date" />
              </div>
            </div>

            <div class="sep"></div>

            <div class="row2">
              <div>
                <label for="tipo">Tipo *</label>
                <select id="tipo">
                  <option>Falta</option>
                  <option>F√©rias</option>
                  <option>Viagem</option>
                  <option>Atestado</option>
                  <option>Outro</option>
                </select>
              </div>
              <div>
                <label for="justificativa">Justificativa *</label>
                <input id="justificativa" placeholder="Ex.: Viagem, atestado m√©dico..." />
              </div>
            </div>

            <div class="sep"></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <button class="btn primary" type="button" id="btnSaveNew">Salvar solicita√ß√£o</button>
              <button class="btn" type="button" id="btnClearNew">Limpar</button>
              <span class="note" id="msgNew"></span>
            </div>

            <div class="sep"></div>

            <div class="note">
              Status inicial: <b>Pendente</b> (interno: <code>SUBMITTED</code>).
            </div>
          </div>
        </div>

        <!-- =========================
             ABA 2: LISTA DE APROVA√á√ïES
        ========================== -->
        <div id="viewApprove" style="display:none">
          <h3 style="margin:0 0 6px 0;font-size:18px">Lista de aprova√ß√µes</h3>
          <div class="muted" style="margin-bottom:12px">Aprove ou recuse solicita√ß√µes pendentes.</div>

          <div id="adminGate1" class="card" style="box-shadow:none">
            <div class="hd"><div class="muted">Acesso restrito (Admin)</div></div>
            <div class="bd">
              <div class="row2">
                <div>
                  <label for="adminPass1">Senha</label>
                  <input id="adminPass1" type="password" placeholder="Digite a senha" />
                </div>
                <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
                  <button class="btn primary" type="button" id="btnAdminLogin1">Entrar</button>
                  <span class="note">Somente administradores podem acessar esta √°rea.</span>
                </div>
              </div>
              <div class="note" id="adminMsg1" style="margin-top:10px"></div>
            </div>
          </div>

          <div id="adminArea1" style="display:none">
            <div class="row2">
              <div>
                <label for="approverName1">Seu nome (aprovador)</label>
                <input id="approverName1" placeholder="Ex.: Admin" />
              </div>
              <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
                <button class="btn" type="button" id="btnRefreshApprove">Atualizar lista</button>
                <span class="note" id="approveMsg"></span>
              </div>
            </div>

            <div class="sep"></div>

            <table>
              <thead>
                <tr>
                  <th>Dt. pedido</th>
                  <th>Profissional</th>
                  <th>In√≠cio</th>
                  <th>Fim</th>
                  <th>Tipo</th>
                  <th>Justificativa</th>
                  <th style="text-align:right">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="approveRows"></tbody>
            </table>

            <div class="note" id="approveEmpty" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- =========================
             ABA 3: GERENCIAR SOLICITA√á√ïES
        ========================== -->
        <div id="viewManage" style="display:none">
          <h3 style="margin:0 0 6px 0;font-size:18px">Gerenciar solicita√ß√µes</h3>
          <div class="muted" style="margin-bottom:12px">Log completo + alterar status + remover.</div>

          <div id="adminGate2" class="card" style="box-shadow:none">
            <div class="hd"><div class="muted">Acesso restrito (Admin)</div></div>
            <div class="bd">
              <div class="row2">
                <div>
                  <label for="adminPass2">Senha</label>
                  <input id="adminPass2" type="password" placeholder="Digite a senha" />
                </div>
                <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
                  <button class="btn primary" type="button" id="btnAdminLogin2">Entrar</button>
                  <span class="note">Somente administradores podem acessar esta √°rea.</span>
                </div>
              </div>
              <div class="note" id="adminMsg2" style="margin-top:10px"></div>
            </div>
          </div>

          <div id="adminArea2" style="display:none">
            <div class="row2">
              <div>
                <label for="filterStatus">Status</label>
                <select id="filterStatus">
                  <option value="ALL">Todos</option>
                  <option value="SUBMITTED">Pendente</option>
                  <option value="APPROVED">Aprovado</option>
                  <option value="REJECTED">Rejeitado</option>
                </select>
              </div>
              <div>
                <label for="filterTipo">Tipo</label>
                <select id="filterTipo">
                  <option value="ALL">Todos</option>
                  <option>Falta</option>
                  <option>F√©rias</option>
                  <option>Viagem</option>
                  <option>Atestado</option>
                  <option>Outro</option>
                </select>
              </div>
            </div>

            <div class="sep"></div>

            <div>
              <label for="filterSearch">Buscar (nome/CPF/justificativa)</label>
              <input id="filterSearch" placeholder="Digite para filtrar..." />
            </div>

            <div class="sep"></div>

            <table>
              <thead>
                <tr>
                  <th>Dt. pedido</th>
                  <th>Profissional</th>
                  <th>CPF</th>
                  <th>In√≠cio</th>
                  <th>Fim</th>
                  <th>Tipo</th>
                  <th>Status</th>
                  <th>Aprovador</th>
                  <th>Dt. decis√£o</th>
                </tr>
              </thead>
              <tbody id="manageTable"></tbody>
            </table>
            <div class="note" id="manageEmpty" style="margin-top:10px"></div>

            <div class="sep"></div>

            <h3 style="margin:0 0 6px 0;font-size:18px">Alterar status</h3>
            <div class="muted" style="margin-bottom:10px">√ötil para corrigir aprova√ß√µes.</div>

            <div class="row2" style="grid-template-columns:2.3fr 1.2fr 1.2fr">
              <div>
                <label for="selChange">Solicita√ß√£o</label>
                <select id="selChange"></select>
              </div>
              <div>
                <label for="newStatus">Novo status</label>
                <select id="newStatus">
                  <option value="SUBMITTED">Pendente</option>
                  <option value="APPROVED">Aprovado</option>
                  <option value="REJECTED">Rejeitado</option>
                </select>
              </div>
              <div>
                <label for="approverName2">Aprovador (para aprovar/reprovar)</label>
                <input id="approverName2" placeholder="Ex.: Admin" />
              </div>
            </div>

            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <button class="btn primary" type="button" id="btnSaveStatus">Salvar altera√ß√£o</button>
              <span class="note" id="statusMsg"></span>
            </div>

            <div class="sep"></div>

            <h3 style="margin:0 0 6px 0;font-size:18px">Remover (somente testes)</h3>
            <div class="muted" style="margin-bottom:10px">Remove do LocalStorage.</div>

            <div class="row2" style="grid-template-columns:2fr 1fr">
              <div>
                <label for="selRemove">Selecione uma solicita√ß√£o para remover</label>
                <select id="selRemove"></select>
              </div>
              <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
                <button class="btn danger" type="button" id="btnRemove">üóëÔ∏è Remover</button>
                <span class="note" id="removeMsg"></span>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>
  </div>
</main>

<script src="./app.js?v=12"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (id) => document.getElementById(id);
  const warn = (text) => {
    const el = $("jsWarn");
    el.style.display = "block";
    el.textContent = text;
  };

  if (!window.App) {
    warn("Erro: app.js n√£o carregou. Confira se o arquivo se chama 'app.js' (min√∫sculo) e se o caminho est√° './app.js'.");
    console.error("window.App indefinido -> app.js n√£o carregou.");
    return;
  }

  const A = window.App;

  // -------- Config (igual Streamlit) --------
  const ADMIN_PASS = "2026";

  // -------- Helpers --------
  function todayYYYYMMDD(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  function parseDate(s){
    if (!s) return null;
    const m = String(s).trim().match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    const dt = new Date(+m[1], +m[2]-1, +m[3]);
    return Number.isNaN(dt.getTime()) ? null : dt;
  }

  function statusLabel(st){
    if (st === "APPROVED") return "Aprovado";
    if (st === "REJECTED") return "Rejeitado";
    return "Pendente";
  }

  function nomeFallback(req, cpfToNome){
    const cpf = (req.cpf || "").trim();
    const nm = (req.nome_profissional || "").trim();
    return nm || cpfToNome[cpf] || cpf || "Sem nome";
  }

  function getCpfMapFromTherapists(){
    const th = A.loadJSON(A.TH_KEY, []);
    const map = {};
    for (const t of th){
      const cpf = (t.cpf || "").trim();
      const nome = (t.profName || t.fullName || "").trim();
      const st = (t.status || "").trim();
      // no Streamlit: lista vem da equipe (ativas ou n√£o). Aqui vamos listar quem tiver CPF v√°lido.
      if (cpf && cpf.length === 11){
        map[cpf] = nome || map[cpf] || "";
      }
    }
    return map;
  }

  function getRequests(){
    return A.loadJSON(A.REQ_KEY, []);
  }

  function saveRequests(items){
    A.saveJSON(A.REQ_KEY, items);
    try { A.renderKpis && A.renderKpis(); } catch(e){}
  }

  // -------- Top KPIs --------
  try { A.renderKpis && A.renderKpis(); } catch(e){}
  try { A.renderTherapistsKpis && A.renderTherapistsKpis(); } catch(e){}
  try { A.wireResetButton && A.wireResetButton(); } catch(e){}

  // -------- Tabs --------
  const viewNew = $("viewNew");
  const viewApprove = $("viewApprove");
  const viewManage = $("viewManage");

  function setTab(which){
    // style buttons
    $("tabNew").classList.remove("primary");
    $("tabApprove").classList.remove("primary");
    $("tabManage").classList.remove("primary");

    viewNew.style.display = "none";
    viewApprove.style.display = "none";
    viewManage.style.display = "none";

    if (which === "NEW"){
      $("tabNew").classList.add("primary");
      viewNew.style.display = "block";
    } else if (which === "APPROVE"){
      $("tabApprove").classList.add("primary");
      viewApprove.style.display = "block";
      renderApprove();
    } else {
      $("tabManage").classList.add("primary");
      viewManage.style.display = "block";
      renderManage();
    }
    sessionStorage.setItem("tab_sol", which);
  }

  $("tabNew").addEventListener("click", () => setTab("NEW"));
  $("tabApprove").addEventListener("click", () => setTab("APPROVE"));
  $("tabManage").addEventListener("click", () => setTab("MANAGE"));

  // -------- Admin gate (session) --------
  function isAdmin(){
    return sessionStorage.getItem("is_admin") === "1";
  }
  function setAdmin(v){
    sessionStorage.setItem("is_admin", v ? "1" : "0");
  }

  function refreshAdminUI(){
    // Approve
    if (isAdmin()){
      $("adminGate1").style.display = "none";
      $("adminArea1").style.display = "block";
      $("adminMsg1").textContent = "";
      $("approverName1").value = sessionStorage.getItem("aprovador_nome") || "";
    } else {
      $("adminGate1").style.display = "block";
      $("adminArea1").style.display = "none";
    }

    // Manage
    if (isAdmin()){
      $("adminGate2").style.display = "none";
      $("adminArea2").style.display = "block";
      $("adminMsg2").textContent = "";
      $("approverName2").value = sessionStorage.getItem("aprovador_nome") || "";
    } else {
      $("adminGate2").style.display = "block";
      $("adminArea2").style.display = "none";
    }
  }

  $("btnAdminLogin1").addEventListener("click", () => {
    const pw = ($("adminPass1").value || "").trim();
    if (pw === ADMIN_PASS){
      setAdmin(true);
      $("adminMsg1").textContent = "Acesso liberado.";
      $("adminMsg1").style.color = "var(--good)";
      refreshAdminUI();
      renderApprove();
    } else {
      $("adminMsg1").textContent = "Senha incorreta.";
      $("adminMsg1").style.color = "var(--bad)";
    }
  });

  $("btnAdminLogin2").addEventListener("click", () => {
    const pw = ($("adminPass2").value || "").trim();
    if (pw === ADMIN_PASS){
      setAdmin(true);
      $("adminMsg2").textContent = "Acesso liberado.";
      $("adminMsg2").style.color = "var(--good)";
      refreshAdminUI();
      renderManage();
    } else {
      $("adminMsg2").textContent = "Senha incorreta.";
      $("adminMsg2").style.color = "var(--bad)";
    }
  });

  // keep approver name
  $("approverName1").addEventListener("input", () => {
    sessionStorage.setItem("aprovador_nome", $("approverName1").value || "");
    $("approverName2").value = $("approverName1").value || "";
  });
  $("approverName2").addEventListener("input", () => {
    sessionStorage.setItem("aprovador_nome", $("approverName2").value || "");
    $("approverName1").value = $("approverName2").value || "";
  });

  // -------- ABA 1: Nova Solicita√ß√£o --------
  const cpfSelect = $("cpfSelect");
  const profissional = $("profissional");
  const dtInicio = $("dtInicio");
  const dtFim = $("dtFim");
  const tipo = $("tipo");
  const justificativa = $("justificativa");
  const msgNew = $("msgNew");

  dtInicio.value = todayYYYYMMDD();
  dtFim.value = todayYYYYMMDD();

  function renderCpfDropdown(){
    const cpfToNome = getCpfMapFromTherapists();
    const cpfs = Object.keys(cpfToNome).filter(c => c && c.length === 11).sort();

    if (!cpfs.length){
      $("noCpfBox").style.display = "block";
      $("newFormBox").style.display = "none";
      return;
    }

    $("noCpfBox").style.display = "none";
    $("newFormBox").style.display = "block";

    cpfSelect.innerHTML = "";
    for (const cpf of cpfs){
      const opt = document.createElement("option");
      opt.value = cpf;
      opt.textContent = `${cpf} ‚Äî ${cpfToNome[cpf] || ""}`;
      cpfSelect.appendChild(opt);
    }
    profissional.value = cpfToNome[cpfs[0]] || "";
  }

  cpfSelect.addEventListener("change", () => {
    const cpfToNome = getCpfMapFromTherapists();
    profissional.value = cpfToNome[cpfSelect.value] || "";
  });

  function clearNewForm(){
    msgNew.textContent = "";
    justificativa.value = "";
    tipo.value = "Falta";
    dtInicio.value = todayYYYYMMDD();
    dtFim.value = todayYYYYMMDD();
    cpfSelect.selectedIndex = 0;
    const cpfToNome = getCpfMapFromTherapists();
    profissional.value = cpfToNome[cpfSelect.value] || "";
  }

  $("btnClearNew").addEventListener("click", clearNewForm);

  $("btnSaveNew").addEventListener("click", () => {
    msgNew.textContent = "";
    msgNew.style.color = "";

    const cpf = (cpfSelect.value || "").trim();
    const nome_profissional = (profissional.value || "").trim();
    const di = (dtInicio.value || "").trim();
    const df = (dtFim.value || "").trim();
    const tp = (tipo.value || "").trim();
    const just = (justificativa.value || "").trim();

    const errors = [];
    if (!cpf) errors.push("CPF √© obrigat√≥rio.");
    if (!just) errors.push("Justificativa √© obrigat√≥ria.");

    const d1 = parseDate(di);
    const d2 = parseDate(df);
    if (!d1) errors.push("Data In√≠cio inv√°lida.");
    if (!d2) errors.push("Data Fim inv√°lida.");
    if (d1 && d2 && d2 < d1) errors.push("Data Fim n√£o pode ser menor que Data In√≠cio.");

    if (errors.length){
      msgNew.textContent = errors.join(" ");
      msgNew.style.color = "var(--bad)";
      return;
    }

    const items = getRequests();
    const row = {
      id: A.uid().slice(0,10),
      dt_pedido: todayYYYYMMDD(),
      cpf,
      nome_profissional,
      dt_inicio: di,
      dt_fim: df,
      tipo: tp,
      justificativa: just,
      status: "SUBMITTED",    // Pendente
      aprovador: "",
      dt_decisao: "",
      created_at: A.nowISO(),
      updated_at: A.nowISO()
    };

    items.unshift(row);
    saveRequests(items);

    msgNew.textContent = "Solicita√ß√£o registrada (status: Pendente).";
    msgNew.style.color = "var(--good)";
    clearNewForm();

    // atualiza listas
    renderApprove();
    renderManage();
  });

  // -------- ABA 2: Aprova√ß√µes --------
  $("btnRefreshApprove").addEventListener("click", renderApprove);

  function renderApprove(){
    refreshAdminUI();
    if (!isAdmin()) return;

    const cpfToNome = getCpfMapFromTherapists();
    const approver = ($("approverName1").value || "").trim();
    const items = getRequests();
    const pending = items.filter(r => r.status === "SUBMITTED");

    const tbody = $("approveRows");
    const empty = $("approveEmpty");
    tbody.innerHTML = "";

    if (!pending.length){
      empty.textContent = "Nenhuma solicita√ß√£o pendente.";
      return;
    }
    empty.textContent = "";

    for (const r of pending.sort((a,b) => String(a.dt_pedido||"").localeCompare(String(b.dt_pedido||"")))){
      const tr = document.createElement("tr");
      const nome = nomeFallback(r, cpfToNome);

      tr.innerHTML = `
        <td>${A.escapeHtml(r.dt_pedido || "")}</td>
        <td>${A.escapeHtml(nome)} (${A.escapeHtml(r.cpf || "")})</td>
        <td>${A.escapeHtml(r.dt_inicio || "")}</td>
        <td>${A.escapeHtml(r.dt_fim || "")}</td>
        <td>${A.escapeHtml(r.tipo || "")}</td>
        <td>${A.escapeHtml(r.justificativa || "")}</td>
        <td style="text-align:right;white-space:nowrap">
          <button class="btn small" type="button" data-ap="${r.id}">‚úÖ</button>
          <button class="btn danger small" type="button" data-re="${r.id}">‚ùå</button>
        </td>
      `;

      tr.querySelector(`[data-ap="${r.id}"]`).addEventListener("click", () => {
        if (!approver){
          $("approveMsg").textContent = "Preencha o nome do aprovador para aprovar.";
          $("approveMsg").style.color = "var(--bad)";
          return;
        }
        const all = getRequests();
        const idx = all.findIndex(x => x.id === r.id);
        if (idx >= 0){
          all[idx].status = "APPROVED";
          all[idx].aprovador = approver;
          all[idx].dt_decisao = A.nowISO();
          all[idx].updated_at = A.nowISO();
          saveRequests(all);
          $("approveMsg").textContent = "Solicita√ß√£o aprovada.";
          $("approveMsg").style.color = "var(--good)";
          renderApprove();
          renderManage();
          try { A.renderKpis && A.renderKpis(); } catch(e){}
        }
      });

      tr.querySelector(`[data-re="${r.id}"]`).addEventListener("click", () => {
        if (!approver){
          $("approveMsg").textContent = "Preencha o nome do aprovador para recusar.";
          $("approveMsg").style.color = "var(--bad)";
          return;
        }
        const all = getRequests();
        const idx = all.findIndex(x => x.id === r.id);
        if (idx >= 0){
          all[idx].status = "REJECTED";
          all[idx].aprovador = approver;
          all[idx].dt_decisao = A.nowISO();
          all[idx].updated_at = A.nowISO();
          saveRequests(all);
          $("approveMsg").textContent = "Solicita√ß√£o recusada.";
          $("approveMsg").style.color = "var(--good)";
          renderApprove();
          renderManage();
          try { A.renderKpis && A.renderKpis(); } catch(e){}
        }
      });

      tbody.appendChild(tr);
    }
  }

  // -------- ABA 3: Gerenciar --------
  $("filterStatus").addEventListener("change", renderManage);
  $("filterTipo").addEventListener("change", renderManage);
  $("filterSearch").addEventListener("input", renderManage);
  $("btnSaveStatus").addEventListener("click", saveStatusChange);
  $("btnRemove").addEventListener("click", removeSelected);

  function makeRowLabel(r, cpfToNome){
    const nome = nomeFallback(r, cpfToNome);
    const di = r.dt_inicio || "";
    const df = r.dt_fim || "";
    const tp = r.tipo || "";
    const st = statusLabel(r.status);
    return `${nome} | ${di} ‚Üí ${df} | ${tp} | ${st}`;
  }

  function renderManage(){
    refreshAdminUI();
    if (!isAdmin()) return;

    const cpfToNome = getCpfMapFromTherapists();
    const items = getRequests();

    // filtros
    const stF = $("filterStatus").value;
    const tpF = $("filterTipo").value;
    const q = ($("filterSearch").value || "").trim().toLowerCase();

    let view = items.slice();

    if (stF !== "ALL") view = view.filter(r => r.status === stF);
    if (tpF !== "ALL") view = view.filter(r => (r.tipo || "") === tpF);

    if (q){
      view = view.filter(r => {
        const nome = nomeFallback(r, cpfToNome).toLowerCase();
        const cpf = String(r.cpf || "").toLowerCase();
        const just = String(r.justificativa || "").toLowerCase();
        return nome.includes(q) || cpf.includes(q) || just.includes(q);
      });
    }

    // sort
    view.sort((a,b) => String(b.dt_pedido||"").localeCompare(String(a.dt_pedido||"")));

    // tabela
    const tbody = $("manageTable");
    const empty = $("manageEmpty");
    tbody.innerHTML = "";

    if (!view.length){
      empty.textContent = "Sem solicita√ß√µes para exibir.";
    } else {
      empty.textContent = "";
      for (const r of view){
        const tr = document.createElement("tr");
        const nome = nomeFallback(r, cpfToNome);
        tr.innerHTML = `
          <td>${A.escapeHtml(r.dt_pedido || "")}</td>
          <td>${A.escapeHtml(nome)}</td>
          <td>${A.escapeHtml(r.cpf || "")}</td>
          <td>${A.escapeHtml(r.dt_inicio || "")}</td>
          <td>${A.escapeHtml(r.dt_fim || "")}</td>
          <td>${A.escapeHtml(r.tipo || "")}</td>
          <td>${A.escapeHtml(statusLabel(r.status))}</td>
          <td>${A.escapeHtml(r.aprovador || "")}</td>
          <td>${A.escapeHtml(r.dt_decisao || "")}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // selects: alterar status / remover
    const selChange = $("selChange");
    const selRemove = $("selRemove");
    selChange.innerHTML = "";
    selRemove.innerHTML = "";

    const allSorted = items.slice().sort((a,b) => String(b.dt_pedido||"").localeCompare(String(a.dt_pedido||"")));
    for (const r of allSorted){
      const label = makeRowLabel(r, cpfToNome);

      const o1 = document.createElement("option");
      o1.value = r.id;
      o1.textContent = label;
      selChange.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = r.id;
      o2.textContent = `${label}`;
      selRemove.appendChild(o2);
    }
  }

  function saveStatusChange(){
    const id = $("selChange").value;
    const newSt = $("newStatus").value;
    const approver = ($("approverName2").value || "").trim();

    $("statusMsg").textContent = "";
    $("statusMsg").style.color = "";

    if (!id) return;

    if ((newSt === "APPROVED" || newSt === "REJECTED") && !approver){
      $("statusMsg").textContent = "Informe o nome do aprovador para definir como Aprovado/Rejeitado.";
      $("statusMsg").style.color = "var(--bad)";
      return;
    }

    const items = getRequests();
    const idx = items.findIndex(x => x.id === id);
    if (idx < 0) return;

    items[idx].status = newSt;

    if (newSt === "SUBMITTED"){
      items[idx].aprovador = "";
      items[idx].dt_decisao = "";
    } else {
      items[idx].aprovador = approver;
      items[idx].dt_decisao = A.nowISO();
    }
    items[idx].updated_at = A.nowISO();

    saveRequests(items);

    $("statusMsg").textContent = "Status atualizado.";
    $("statusMsg").style.color = "var(--good)";

    renderApprove();
    renderManage();
    try { A.renderKpis && A.renderKpis(); } catch(e){}
  }

  function removeSelected(){
    const id = $("selRemove").value;
    if (!id) return;

    if (!confirm("Remover esta solicita√ß√£o?")) return;

    const items = getRequests().filter(x => x.id !== id);
    saveRequests(items);

    $("removeMsg").textContent = "Solicita√ß√£o removida.";
    $("removeMsg").style.color = "var(--good)";

    renderApprove();
    renderManage();
  }

  // -------- Init --------
  refreshAdminUI();
  renderCpfDropdown();
  renderApprove();
  renderManage();

  const lastTab = sessionStorage.getItem("tab_sol") || "NEW";
  setTab(lastTab);
});
</script>
</body>
</html>
