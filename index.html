<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard | Hara Spa</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:'Segoe UI',sans-serif;background:#f5f7fb;}
.app{display:flex;min-height:100vh;}
#sidebar{width:260px;flex-shrink:0;}
.content{flex:1;padding:40px;}

.card{
  background:#fff;
  border-radius:25px;
  padding:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.top-cards{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:30px;
  margin-bottom:40px;
}

.big-number{
  font-size:60px;
  font-weight:bold;
  margin-top:10px;
}

.label-small{color:#666;font-size:14px;}

.folgas{
  background:#fff;
  border-radius:25px;
  padding:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.folga-item{
  padding:8px 0;
  border-bottom:1px solid #eee;
  font-size:14px;
}

.folga-dia{
  color:#dc2626;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="app">
<aside id="sidebar"></aside>

<main class="content">

<div class="top-cards">

  <div class="card">
    <h3>Equipe</h3>
    <div class="big-number" id="totalEquipe">0</div>
    <div class="label-small">Terapeutas cadastradas</div>
  </div>

  <div class="card">
    <h3>Clientes</h3>
    <div class="big-number" id="totalClientes">0</div>
    <div class="label-small">Clientes cadastrados</div>
  </div>

  <div class="card">
    <h3>Serviços</h3>
    <div class="big-number" id="totalServicos">0</div>
    <div class="label-small">Serviços ativos</div>
  </div>

</div>

<div class="folgas">
  <h3>Folgas em 2026</h3>
  <div id="listaFolgas"></div>
</div>

</main>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="assets/sidebar/sidebar.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async function(){

const supabaseClient = supabase.createClient(
  "https://rymehgsoarjeecuwyhny.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTc0ODUsImV4cCI6MjA4NjIzMzQ4NX0.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec"
);

/* =========================
   BUSCAR DADOS
========================= */

const { data: terapeutas } = await supabaseClient
  .from("terapeutas")
  .select("*");

const { data: clientes } = await supabaseClient
  .from("clientes")
  .select("*");

const { data: servicos } = await supabaseClient
  .from("servicos")
  .select("*")
  .ilike("status","ativo");

document.getElementById("totalEquipe").innerText = terapeutas?.length || 0;
document.getElementById("totalClientes").innerText = clientes?.length || 0;
document.getElementById("totalServicos").innerText = servicos?.length || 0;

/* =========================
   CÁLCULO FOLGAS 2026
========================= */

const hoje = new Date();
const inicioAno = new Date(2026,0,1);

const mapaDia = {
  "domingo":0,
  "segunda":1,
  "terça":2,
  "terca":2,
  "quarta":3,
  "quinta":4,
  "sexta":5,
  "sábado":6,
  "sabado":6
};

const folgaDiv = document.getElementById("listaFolgas");
folgaDiv.innerHTML="";

for(const t of (terapeutas||[])){

  if(!t.dia_folga || !t.tem_folga) continue;

  if(String(t.tem_folga).toLowerCase() !== "sim") continue;

  const diaNumero = mapaDia[t.dia_folga.toLowerCase()];
  if(diaNumero === undefined) continue;

  const dataAdmissao = new Date(t.data_inicio);
  const dataBase = dataAdmissao > inicioAno ? dataAdmissao : inicioAno;

  let contadorSemanal = 0;
  let dataLoop = new Date(dataBase);

  while(dataLoop <= hoje){
    if(dataLoop.getDay() === diaNumero){
      contadorSemanal++;
    }
    dataLoop.setDate(dataLoop.getDate()+1);
  }

  /* SOMAR SOLICITAÇÕES APROVADAS */

  const { data: solicitacoes } = await supabaseClient
    .from("solicitacoes")
    .select("data_inicio,data_fim")
    .eq("terapeuta_cpf",t.cpf)
    .eq("status","Aprovado");

  let diasAprovados = 0;

  (solicitacoes||[]).forEach(s=>{
    const inicio = new Date(s.data_inicio);
    const fim = new Date(s.data_fim);

    const inicioConsiderado = inicio < inicioAno ? inicioAno : inicio;
    const diff = Math.floor((fim-inicioConsiderado)/(1000*60*60*24))+1;

    if(diff>0) diasAprovados += diff;
  });

  const total = contadorSemanal + diasAprovados;

  folgaDiv.innerHTML += `
    <div class="folga-item">
      ${t.nome_profissional} —
      <span class="folga-dia">${total} folgas</span>
    </div>
  `;
}

});
</script>

</body>
</html>
