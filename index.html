<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard | Hara Spa</title>

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:'Segoe UI',sans-serif;background:#f5f7fb;}
.app{display:flex;min-height:100vh;}
#sidebar{width:260px;flex-shrink:0;}
.content{flex:1;padding:40px;}

.card{
  background:#fff;
  border-radius:25px;
  padding:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.top-cards{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:30px;
  margin-bottom:40px;
}

.big-number{
  font-size:60px;
  font-weight:bold;
  margin-top:10px;
}

.label-small{color:#666;font-size:14px;}

.workforce{
  background:#fff;
  border-radius:25px;
  padding:30px;
  display:flex;
  gap:40px;
  margin-bottom:40px;
}

.chart{flex:2;}

.chart-wrapper{
  display:flex;
  align-items:flex-end;
  gap:16px;
  height:260px;
  margin-top:30px;
}

.bar-container{
  display:flex;
  flex-direction:column;
  align-items:center;
  width:40px;
}

.bar{
  width:100%;
  background:linear-gradient(180deg,#6a8fd6,#4f6fb3);
  border-radius:8px 8px 0 0;
}

.bar-value{font-size:12px;margin-bottom:6px;}
.bar-hour{margin-top:6px;font-size:12px;color:#555;}

.rank{flex:1;border-left:1px solid #eee;padding-left:30px;}
.rank-item{padding:6px 0;border-bottom:1px solid #eee;font-size:14px;}

.folgas{
  background:#fff;
  border-radius:25px;
  padding:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.folga-item{
  padding:8px 0;
  border-bottom:1px solid #eee;
  font-size:14px;
}

.folga-dia{
  color:#dc2626;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="app">
<aside id="sidebar"></aside>

<main class="content">

<div class="top-cards">

  <div class="card">
    <h3>Equipe</h3>
    <div class="big-number" id="totalEquipe">0</div>
    <div class="label-small">Terapeutas cadastradas</div>
  </div>

  <div class="card">
    <h3>Clientes</h3>
    <div class="big-number" id="totalClientes">0</div>
    <div class="label-small">Clientes cadastrados</div>
  </div>

  <div class="card">
    <h3>Serviços</h3>
    <div class="big-number" id="totalServicos">0</div>
    <div class="label-small">Serviços ativos</div>
  </div>

</div>

<div class="workforce">

  <div class="chart">
    <h3>Força de Trabalho (por hora)</h3>
    <div class="chart-wrapper" id="bars"></div>
  </div>

  <div class="rank">
    <h3>Carga horária (Ranking)</h3>
    <div id="ranking"></div>
  </div>

</div>

<div class="folgas">
  <h3>Folgas em 2026</h3>
  <div id="listaFolgas"></div>
</div>

</main>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="assets/sidebar/sidebar.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async function(){

const supabaseClient = supabase.createClient(
  "https://rymehgsoarjeecuwyhny.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTc0ODUsImV4cCI6MjA4NjIzMzQ4NX0.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec"
);

/* ================= BUSCAR DADOS ================= */

const { data: terapeutas } = await supabaseClient.from("terapeutas").select("*");
const { data: clientes } = await supabaseClient.from("clientes").select("*");
const { data: servicos } = await supabaseClient.from("servicos").select("*").ilike("status","ativo");

document.getElementById("totalEquipe").innerText = terapeutas?.length || 0;
document.getElementById("totalClientes").innerText = clientes?.length || 0;
document.getElementById("totalServicos").innerText = servicos?.length || 0;

/* ================= CARGA HORÁRIA ================= */

let ranking = [];

const inicioDia = 9;
const fimDia = 21;
let contagem = {};

for(let h=inicioDia;h<=fimDia;h++) contagem[h]=0;

(terapeutas||[]).forEach(t=>{
  if(!t.hora_entrada || !t.hora_saida) return;

  const [h1,m1]=t.hora_entrada.substring(0,5).split(":").map(Number);
  const [h2,m2]=t.hora_saida.substring(0,5).split(":").map(Number);

  const totalMin=(h2*60+m2)-(h1*60+m1);
  ranking.push({nome:t.nome_profissional,minutos:totalMin});

  for(let h=inicioDia;h<=fimDia;h++){
    if(h>=h1 && h<h2) contagem[h]++;
  }
});

/* RENDER BARRAS */

const barsDiv=document.getElementById("bars");
const maxValor=Math.max(...Object.values(contagem));

for(let h=inicioDia;h<=fimDia;h++){
  const valor=contagem[h];
  const altura=maxValor? (valor/maxValor)*200 : 0;

  barsDiv.innerHTML+=`
    <div class="bar-container">
      <div class="bar-value">${valor}</div>
      <div class="bar" style="height:${altura}px"></div>
      <div class="bar-hour">${h}:00</div>
    </div>
  `;
}

/* RANKING */

ranking.sort((a,b)=>b.minutos-a.minutos);

const rankDiv=document.getElementById("ranking");

ranking.forEach(r=>{
  const horas=Math.floor(r.minutos/60);
  const minutos=r.minutos%60;

  rankDiv.innerHTML+=`
    <div class="rank-item">
      ${r.nome} — ${horas}h ${minutos}m
    </div>
  `;
});

/* ================= FOLGAS 2026 ================= */

const hoje=new Date();
const inicioAno=new Date(2026,0,1);

const mapaDia={
  "domingo":0,
  "segunda":1,
  "terça":2,
  "terca":2,
  "quarta":3,
  "quinta":4,
  "sexta":5,
  "sábado":6,
  "sabado":6
};

const folgaDiv=document.getElementById("listaFolgas");

for(const t of (terapeutas||[])){

  if(!t.dia_folga || String(t.tem_folga).toLowerCase()!=="sim") continue;

  const diaNumero=mapaDia[t.dia_folga.toLowerCase()];
  if(diaNumero===undefined) continue;

  const admissao=new Date(t.data_inicio);
  const dataBase=admissao>inicioAno?admissao:inicioAno;

  let contador=0;
  let dataLoop=new Date(dataBase);

  while(dataLoop<=hoje){
    if(dataLoop.getDay()===diaNumero) contador++;
    dataLoop.setDate(dataLoop.getDate()+1);
  }

  const { data: solicitacoes } = await supabaseClient
    .from("solicitacoes")
    .select("data_inicio,data_fim")
    .eq("terapeuta_cpf",t.cpf)
    .eq("status","Aprovado");

  let diasAprovados=0;

  (solicitacoes||[]).forEach(s=>{
    const inicio=new Date(s.data_inicio);
    const fim=new Date(s.data_fim);
    const inicioConsiderado=inicio<inicioAno?inicioAno:inicio;
    const diff=Math.floor((fim-inicioConsiderado)/(1000*60*60*24))+1;
    if(diff>0) diasAprovados+=diff;
  });

  const total=contador+diasAprovados;

  folgaDiv.innerHTML+=`
    <div class="folga-item">
      ${t.nome_profissional} —
      <span class="folga-dia">${total} folgas</span>
    </div>
  `;
}

});
</script>

</body>
</html>
