<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Escalas</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<link rel="stylesheet" href="assets/css/style.css">
<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<style>
.content { padding:30px; font-size:14px; }
.header { display:flex; justify-content:space-between; align-items:center; }
.card { background:#fff; border-radius:18px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.05); }

.layout { display:grid; grid-template-columns:2.2fr 1.4fr; gap:20px; margin-top:20px; }

.calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:10px; }
.weekdays { margin-top:16px; }
.weekdays div { text-align:center; font-weight:600; font-size:13px; }

.day { border:1px solid #e5e7eb; border-radius:10px; padding:10px; cursor:pointer; min-height:90px; }
.day:hover { background:#f1f5f9; }

.day-number { font-weight:700; }

.section-title { margin-top:20px; font-weight:700; }
.detail-item { padding:8px 0; border-bottom:1px solid #e5e7eb; }

.badge-red { background:#fee2e2; color:#991b1b; padding:2px 6px; border-radius:6px; font-size:11px; margin-left:6px; }
</style>
</head>

<body>
<div class="app">
<aside id="sidebar"></aside>

<main class="content">
<div class="header">
<h1>Escalas</h1>
<input type="date" id="dataSelecionada">
</div>

<div class="layout">

<div class="card">
<h3>Calendário</h3>

<div class="calendar weekdays">
<div>Dom</div><div>Seg</div><div>Ter</div>
<div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
</div>

<div class="calendar" id="calendar"></div>
</div>

<div class="card">
<h3 id="tituloDia">Selecione um dia</h3>
<div id="detalhesDia">—</div>

<div class="section-title">Força de Trabalho</div>
<canvas id="graficoDia" height="140"></canvas>
</div>

</div>
</main>
</div>

<script src="assets/sidebar/sidebar.js"></script>

<script>
const supabase = window.supabase.createClient(
  "https://rymehgsoarjeecuwyhny.supabase.co",
  "SUA_ANON_KEY_AQUI"
);

let terapeutas = [];
let solicitacoes = [];
let chartDia = null;

let hoje = new Date();
let ano = hoje.getFullYear();
let mes = hoje.getMonth();

document.getElementById("dataSelecionada").valueAsDate = hoje;

document.getElementById("dataSelecionada").addEventListener("change", e=>{
  const d = new Date(e.target.value);
  ano = d.getFullYear();
  mes = d.getMonth();
  renderCalendar();
});

function diaSemana(date){
  return ["domingo","segunda","terça","quarta","quinta","sexta","sábado"][date.getDay()];
}

function folgaSemanal(t,data){
  return t.tem_folga==="Sim" &&
         t.dia_folga &&
         diaSemana(data)===t.dia_folga.toLowerCase();
}

function folgaAprovada(t,data){
  return solicitacoes.some(s =>
    s.status==="Aprovado" &&
    s.terapeuta_cpf===t.cpf &&
    data >= new Date(s.data_inicio) &&
    data <= new Date(s.data_fim)
  );
}

async function carregarDados(){

  const { data: dadosTerapeutas } = await supabase
    .from("terapeutas")
    .select("*")
    .eq("status","Ativo");

  const { data: dadosSolicitacoes } = await supabase
    .from("solicitacoes")
    .select("*")
    .eq("status","Aprovado");

  terapeutas = dadosTerapeutas || [];
  solicitacoes = dadosSolicitacoes || [];

  renderCalendar();
}

function renderCalendar(){
  const calendar = document.getElementById("calendar");
  calendar.innerHTML="";

  const primeiroDia = new Date(ano,mes,1).getDay();
  const totalDias = new Date(ano,mes+1,0).getDate();

  for(let i=0;i<primeiroDia;i++){
    calendar.appendChild(document.createElement("div"));
  }

  for(let d=1; d<=totalDias; d++){
    const dataDia = new Date(ano,mes,d);

    const qtd = terapeutas.filter(t =>
      t.hora_entrada && t.hora_saida &&
      !folgaSemanal(t,dataDia) &&
      !folgaAprovada(t,dataDia)
    ).length;

    const div = document.createElement("div");
    div.className="day";
    div.innerHTML=`
      <div class="day-number">${d}</div>
      <small>${qtd} terapeutas</small>
    `;
    div.onclick=()=>mostrarDia(d);
    calendar.appendChild(div);
  }
}

function mostrarDia(dia){
  const data = new Date(ano,mes,dia);
  document.getElementById("tituloDia").innerText=
    `Dia ${dia}/${mes+1}/${ano}`;

  const detalhes = document.getElementById("detalhesDia");
  detalhes.innerHTML="";

  const disponiveis = terapeutas.filter(t =>
    t.hora_entrada && t.hora_saida &&
    !folgaSemanal(t,data) &&
    !folgaAprovada(t,data)
  );

  detalhes.innerHTML += `<div class="section-title">
  Disponíveis (${disponiveis.length})
  </div>`;

  disponiveis.forEach(t=>{
    detalhes.innerHTML += `
      <div class="detail-item">
        <b>${t.nome_profissional}</b><br>
        ${t.hora_entrada} – ${t.hora_saida}
      </div>`;
  });

  const indisponiveis = terapeutas.filter(t =>
    folgaSemanal(t,data) || folgaAprovada(t,data)
  );

  detalhes.innerHTML += `<div class="section-title">
  Indisponíveis (${indisponiveis.length})
  </div>`;

  indisponiveis.forEach(t=>{
    let motivo = folgaSemanal(t,data)
      ? `Folga semanal (${t.dia_folga})`
      : "Folga aprovada";

    detalhes.innerHTML += `
      <div class="detail-item">
        <b>${t.nome_profissional}</b>
        <span class="badge-red">${motivo}</span>
      </div>`;
  });

  renderForcaTrabalho(disponiveis);
}

function renderForcaTrabalho(lista){

  const horas=[];
  for(let h=9;h<=22;h++) horas.push(h);

  const contagem = horas.map(hora =>
    lista.filter(t=>{
      const he=parseInt(t.hora_entrada.split(":")[0]);
      const hs=parseInt(t.hora_saida.split(":")[0]);
      return hora>=he && hora<hs;
    }).length
  );

  if(chartDia) chartDia.destroy();

  chartDia = new Chart(document.getElementById("graficoDia"),{
    type:"bar",
    data:{
      labels:horas.map(h=>h+":00"),
      datasets:[{
        label:"Terapeutas disponíveis",
        data:contagem,
        backgroundColor:"#3b82f6"
      }]
    },
    options:{
      scales:{ y:{ beginAtZero:true, ticks:{stepSize:1} } }
    }
  });
}

carregarDados();
</script>

</body>
</html>
