<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard | Hara Spa</title>

<!-- FONT AWESOME -->
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="assets/sidebar/sidebar.css">

<style>

/* RESET BASE */
* {
  box-sizing: border-box;
}

body {
  margin:0;
  font-family:'Segoe UI', sans-serif;
  background:#f5f7fb;
}

/* LAYOUT PADRÃO GLOBAL */
.app {
  display:flex;
  min-height:100vh;
}

#sidebar {
  width:260px;
  flex-shrink:0;
}

.content {
  flex:1;
  padding:40px;
}

/* DASHBOARD */

.card {
  background:#fff;
  border-radius:25px;
  padding:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}

.top-cards {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:30px;
  margin-bottom:40px;
}

.big-number {
  font-size:60px;
  font-weight:bold;
}

.workforce {
  background:#fff;
  border-radius:25px;
  padding:30px;
  display:flex;
  gap:40px;
}

.chart {
  flex:3;
}

.chart-wrapper {
  display:flex;
  align-items:flex-end;
  gap:16px;
  height:260px;
  margin-top:30px;
}

.bar-container {
  display:flex;
  flex-direction:column;
  align-items:center;
  width:40px;
}

.bar-value {
  font-size:12px;
  font-weight:600;
  margin-bottom:6px;
  color:#333;
}

.bar {
  width:100%;
  background:linear-gradient(180deg,#6a8fd6,#4f6fb3);
  border-radius:8px 8px 0 0;
  transition:.3s;
}

.bar:hover {
  opacity:.85;
}

.bar-hour {
  margin-top:8px;
  font-size:12px;
  color:#555;
}

.work-info {
  flex:1;
  border-left:1px solid #eee;
  padding-left:30px;
}

.work-info p {
  margin:8px 0;
  font-size:14px;
}

</style>
</head>

<body>

<div class="app">

  <aside id="sidebar"></aside>

  <main class="content">

    <div class="top-cards">
      <div class="card">
        <h3>Equipe</h3>
        <div class="big-number" id="totalEquipe">0</div>
        <p>Terapeutas ativas</p>
      </div>

      <div class="card">
        <h3>Resumo</h3>
        <p>Dados atualizados em tempo real</p>
      </div>

      <div class="card">
        <h3>Status</h3>
        <p>Sistema operacional</p>
      </div>
    </div>

    <div class="workforce">

      <div class="chart">
        <h3>Força de Trabalho</h3>
        <div class="chart-wrapper" id="bars"></div>
      </div>

      <div class="work-info">
        <h3>Carga horária</h3>
        <div id="cargaHoraria"></div>
      </div>

    </div>

  </main>

</div>

<script src="assets/sidebar/sidebar.js"></script>

<script>

const supabaseClient = supabase.createClient(
  "https://rymehgsoarjeecuwyhny.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5bWVoZ3NvYXJqZWVjdXd5aG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTc0ODUsImV4cCI6MjA4NjIzMzQ4NX0.K9BUapByrh6TsSi5jEkL8HGLDmMT_tGSSykl7LGxIec"
);

async function carregarDashboard() {

  const { data, error } = await supabaseClient
    .from("terapeutas")
    .select("nome_profissional,hora_entrada,hora_saida,status")
    .eq("status","Ativo")
    .order("nome_profissional");

  if (error) {
    console.error(error);
    return;
  }

  document.getElementById("totalEquipe").innerText = data.length;

  const cargaDiv = document.getElementById("cargaHoraria");
  cargaDiv.innerHTML = "";

  data.forEach(t => {
    if (!t.hora_entrada || !t.hora_saida) return;

    const [h1,m1] = t.hora_entrada.substring(0,5).split(":").map(Number);
    const [h2,m2] = t.hora_saida.substring(0,5).split(":").map(Number);

    const totalMin = (h2*60+m2) - (h1*60+m1);

    const horas = Math.floor(totalMin / 60);
    const minutos = totalMin % 60;

    cargaDiv.innerHTML += 
      `<p>${t.nome_profissional}: ${horas}:${minutos.toString().padStart(2,'0')} horas</p>`;
  });

  const inicioDia = 9;
  const fimDia = 21;
  const contagem = {};

  for (let h = inicioDia; h <= fimDia; h++) contagem[h] = 0;

  data.forEach(t => {

    if (!t.hora_entrada || !t.hora_saida) return;

    const [h1,m1] = t.hora_entrada.substring(0,5).split(":").map(Number);
    const [h2,m2] = t.hora_saida.substring(0,5).split(":").map(Number);

    const inicio = h1*60 + m1;
    const fim = h2*60 + m2;

    for (let h = inicioDia; h <= fimDia; h++) {
      const slotInicio = h * 60;
      const slotFim = (h + 1) * 60;

      if (inicio < slotFim && fim >= slotInicio) {
        contagem[h]++;
      }
    }
  });

  const maxValor = Math.max(...Object.values(contagem));
  const barsDiv = document.getElementById("bars");
  barsDiv.innerHTML = "";

  for (let h = inicioDia; h <= fimDia; h++) {

    const valor = contagem[h];
    const altura = maxValor === 0 ? 0 : (valor / maxValor) * 200;

    barsDiv.innerHTML += `
      <div class="bar-container">
        <div class="bar-value">${valor}</div>
        <div class="bar" style="height:${altura}px"></div>
        <div class="bar-hour">${h}:00</div>
      </div>
    `;
  }

}

carregarDashboard();

</script>

</body>
</html>
