<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>In√≠cio</title>

<link rel="stylesheet" href="assets/css/style.css">
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.cards {
  display: grid;
  grid-template-columns: 1.1fr 1.6fr 1.2fr;
  gap: 16px;
}

.card {
  background: #fff;
  padding: 16px;
  border-radius: 18px;
  box-shadow: 0 0 8px rgba(0,0,0,.05);
}

.card h3 {
  margin: 0;
  font-size: 14px;
}

.kpi {
  font-size: 34px;
  font-weight: 700;
  margin-top: 6px;
}

.small {
  font-size: 12px;
  color: #666;
}

.section-row {
  display: grid;
  grid-template-columns: 3.2fr 1.3fr;
  gap: 16px;
}

.rank div {
  margin-bottom: 6px;
  font-size: 13px;
}
</style>
</head>

<body>

<!-- MENU -->
<nav class="sidebar">
  <h2>Hara Spa</h2>
  <a href="index.html" class="active"><i class="fa-solid fa-house"></i> In√≠cio</a>
  <a href="equipe.html"><i class="fa-solid fa-users"></i> Gest√£o da Equipe</a>
  <a href="solicitacoes.html"><i class="fa-solid fa-calendar-xmark"></i> Solicita√ß√µes</a>
  <a href="escalas.html"><i class="fa-solid fa-calendar-days"></i> Escalas</a>
</nav>

<div class="content">
  <h1>In√≠cio</h1>

  <!-- KPIs -->
  <div class="cards">

    <div class="card">
      <h3>Equipe üë•</h3>
      <div class="kpi" id="kpiEquipe">0</div>
      <div class="small">Funcion√°rias ativas</div>
    </div>

    <div class="card">
      <h3>Pr√≥ximas Datas üìÖ</h3>
      <div class="small">‚Äî</div>
    </div>

    <div class="card">
      <h3>Dias Folgados üèÜ</h3>
      <div id="diasFolga" class="small" style="margin-top:8px;"></div>
    </div>

  </div>

  <br>

  <!-- FOR√áA DE TRABALHO + CARGA HOR√ÅRIA -->
  <div class="section-row">

    <div class="card">
      <h3>For√ßa de Trabalho</h3>
      <canvas id="grafico"></canvas>
      <div class="small">Distribui√ß√£o por hora</div>
    </div>

    <div class="card">
      <h3>Carga Hor√°ria</h3>
      <div id="rankHoras" class="rank"></div>
    </div>

  </div>
</div>

<script>
// =========================
// LOAD STORAGE
// =========================
const terapeutas =
  JSON.parse(localStorage.getItem("terapeutas")) || [];
const solicitacoes =
  JSON.parse(localStorage.getItem("solicitacoes")) || [];

// =========================
// KPI EQUIPE (ATIVAS)
// =========================
const ativas = terapeutas.filter(t =>
  !t.status || t.status === "Ativo"
);
document.getElementById("kpiEquipe").innerText = ativas.length;

// =========================
// DIAS FOLGADOS (CORRIGIDO)
// =========================
const diasPorPessoa = {};

solicitacoes
  .filter(s => s.status === "Aprovado")
  .forEach(s => {
    if (!s.dtInicio || !s.dtFim) return;

    const inicio = new Date(s.dtInicio);
    const fim = new Date(s.dtFim);

    if (isNaN(inicio) || isNaN(fim)) return;

    const dias =
      Math.floor((fim - inicio) / (1000 * 60 * 60 * 24)) + 1;

    if (dias <= 0) return;

    const nome = s.terapeutaNome || "‚Äî";
    diasPorPessoa[nome] =
      (diasPorPessoa[nome] || 0) + dias;
  });

const folgaDiv = document.getElementById("diasFolga");

const ranking = Object.entries(diasPorPessoa)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5);

if (ranking.length === 0) {
  folgaDiv.innerHTML = "Sem dados ainda.";
} else {
  ranking.forEach(([nome, dias]) => {
    folgaDiv.innerHTML += `<div><b>${nome}</b>: ${dias} dias</div>`;
  });
}

// =========================
// FOR√áA DE TRABALHO
// =========================
const horas = Array.from({ length: 14 }, (_, i) => i + 9);

const contagem = horas.map(h => {
  return ativas.filter(t => {
    if (!t.horaEntrada || !t.horaSaida) return false;
    const he = Number(t.horaEntrada.split(":")[0]);
    const hs = Number(t.horaSaida.split(":")[0]);
    return h >= he && h < hs;
  }).length;
});

new Chart(document.getElementById("grafico"), {
  type: "bar",
  data: {
    labels: horas.map(h => `${h}:00`),
    datasets: [{
      label: "Terapeutas ativas",
      data: contagem,
      backgroundColor: "#3b82f6"
    }]
  },
  options: {
    scales: {
      y: { beginAtZero: true, ticks: { stepSize: 1 } }
    }
  }
});

// =========================
// CARGA HOR√ÅRIA
// =========================
const horasRank = ativas
  .map(t => {
    if (!t.horaEntrada || !t.horaSaida) return null;
    const horas =
      Number(t.horaSaida.split(":")[0]) -
      Number(t.horaEntrada.split(":")[0]);
    return {
      nome: t.nomeProfissional || t.nomeCompleto,
      horas
    };
  })
  .filter(Boolean)
  .sort((a, b) => b.horas - a.horas)
  .slice(0, 5);

const rankDiv = document.getElementById("rankHoras");
horasRank.forEach(r => {
  rankDiv.innerHTML += `<div>${r.nome}: ${r.horas}h</div>`;
});
</script>

</body>
</html>
