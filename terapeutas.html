<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal MVP • Terapeutas</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Portal MVP</h1>
          <div class="muted">Terapeutas</div>
        </div>
      </div>
      <div class="kpi">
        <span class="pill">Total: <strong id="kpiTotal">0</strong></span>
        <span class="pill">Abertas: <strong id="kpiOpen">0</strong></span>
        <span class="pill">Aprovadas: <strong id="kpiApproved">0</strong></span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- MENU -->
    <section class="card">
      <div class="hd"><div class="muted">Navegação</div></div>
      <div class="bd">
        <div class="nav">
          <a class="btn" href="./index.html">Início</a>
          <a class="btn" href="./nova-solicitacao.html">Nova solicitação</a>
          <a class="btn" href="./solicitacoes.html">Solicitações</a>
          <a class="btn" href="./equipe.html">Equipe</a>
          <a class="btn primary" href="./terapeutas.html">Terapeutas</a>
          <a class="btn" href="./governanca.html">Governança</a>
        </div>
      </div>
      <div class="ft">
        <button class="btn danger small" id="btnReset" type="button">Zerar dados</button>
        <span class="note">Somente local</span>
      </div>
    </section>

    <!-- CONTEÚDO -->
    <section class="card">
      <div class="hd">
        <h2 style="margin:0;font-size:18px">Terapeutas</h2>
        <div class="muted">Cadastro completo + certificações dinâmicas (LocalStorage).</div>
      </div>

      <div class="bd">
        <div id="jsWarn" class="note" style="display:none;color:var(--bad);margin-bottom:12px"></div>

        <!-- LISTA -->
        <div id="viewList">
          <div class="row2">
            <div>
              <label for="th_filter">Filtrar por status</label>
              <select id="th_filter">
                <option value="ALL">Todos</option>
                <option value="Ativo">Ativo</option>
                <option value="Inativo">Inativo</option>
              </select>
            </div>
            <div>
              <label for="th_q">Buscar</label>
              <input id="th_q" placeholder="Buscar por nome, unidade, CPF, e-mail..." />
            </div>
          </div>

          <div class="sep"></div>

          <button class="btn primary" id="btnNew" type="button">Novo terapeuta</button>

          <div class="sep"></div>

          <table><tbody id="th_rows"></tbody></table>
          <div class="note" id="th_empty"></div>
        </div>

        <!-- FORM -->
        <div id="viewForm" style="display:none">
          <input type="hidden" id="th_id">

          <h3 style="margin:0 0 6px 0;font-size:18px" id="formTitle">Nova Terapeuta</h3>
          <div class="muted" style="margin-bottom:14px">Preencha os dados da terapeuta</div>

          <div class="row2">
            <div>
              <label for="fullName">Nome Completo *</label>
              <input id="fullName" />
            </div>
            <div>
              <label for="profName">Nome profissional *</label>
              <input id="profName" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="row2">
            <div>
              <label for="birthDate">Data de Nascimento *</label>
              <input id="birthDate" type="date" />
            </div>
            <div>
              <label for="cpf">CPF * (11 dígitos)</label>
              <input id="cpf" placeholder="Somente números" inputmode="numeric" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="row2">
            <div>
              <label for="email">Email *</label>
              <input id="email" type="email" />
            </div>
            <div>
              <label for="unit">Unidade *</label>
              <select id="unit"></select>

              <div class="muted" style="margin-top:8px">Adicionar unidade (opcional)</div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
                <input id="unitNew" placeholder="Ex.: Unidade 3" />
                <button class="btn" type="button" id="btnAddUnit">Adicionar</button>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row2">
            <div>
              <label for="address">Endereço</label>
              <input id="address" />
            </div>
            <div>
              <label for="contact">Contato *</label>
              <input id="contact" placeholder="Ex.: 11999999999" inputmode="tel" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="row2">
            <div>
              <label for="emergency">Contato Emergência</label>
              <input id="emergency" placeholder="Ex.: 11999999999" inputmode="tel" />
            </div>
            <div>
              <label for="pixType">Tipo de Chave Pix</label>
              <select id="pixType">
                <option value="CPF">CPF</option>
                <option value="CNPJ">CNPJ</option>
                <option value="Email">Email</option>
                <option value="Telefone">Telefone</option>
                <option value="Aleatória">Aleatória</option>
              </select>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row2">
            <div>
              <label for="pixKey">Chave Pix</label>
              <input id="pixKey" />
            </div>
            <div>
              <label for="hasOff">Tem Folga semanal? *</label>
              <select id="hasOff">
                <option value="Sim">Sim</option>
                <option value="Não">Não</option>
              </select>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row2">
            <div>
              <label for="offDay">Dia da Folga</label>
              <select id="offDay">
                <option value="">--</option>
                <option value="Segunda">Segunda</option>
                <option value="Terça">Terça</option>
                <option value="Quarta">Quarta</option>
                <option value="Quinta">Quinta</option>
                <option value="Sexta">Sexta</option>
                <option value="Sábado">Sábado</option>
                <option value="Domingo">Domingo</option>
              </select>
              <div class="note" style="margin-top:8px">Se “Tem folga semanal” = Sim, selecione o dia.</div>
            </div>
            <div>
              <label for="bloodType">Tipo Sanguíneo</label>
              <select id="bloodType">
                <option value="">--</option>
                <option value="A+">A+</option><option value="A-">A-</option>
                <option value="B+">B+</option><option value="B-">B-</option>
                <option value="AB+">AB+</option><option value="AB-">AB-</option>
                <option value="O+">O+</option><option value="O-">O-</option>
              </select>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row2">
            <div>
              <label for="startTime">Horário de Entrada *</label>
              <input id="startTime" type="time" />
            </div>
            <div>
              <label for="endTime">Horário de Saída *</label>
              <input id="endTime" type="time" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="row2">
            <div>
              <label for="startDate">Data de Início *</label>
              <input id="startDate" type="date" />
            </div>
            <div>
              <label>Status *</label>
              <div style="display:flex;gap:18px;align-items:center;margin-top:6px;flex-wrap:wrap">
                <label style="display:flex;gap:8px;align-items:center;margin:0;color:var(--muted)">
                  <input type="radio" name="status" value="Ativo" checked> Ativo
                </label>
                <label style="display:flex;gap:8px;align-items:center;margin:0;color:var(--muted)">
                  <input type="radio" name="status" value="Inativo"> Inativo
                </label>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <h3 style="margin:0 0 8px 0;font-size:18px">Certificações</h3>
          <div class="muted" style="margin-bottom:10px">Marque as certificações e/ou adicione novas.</div>

          <div id="certBox" style="display:flex;gap:12px;flex-wrap:wrap"></div>

          <div class="sep"></div>

          <div class="row2">
            <div>
              <label for="certNew">Adicionar certificação</label>
              <input id="certNew" placeholder="Ex.: Drenagem Linfática" />
            </div>
            <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
              <button class="btn" type="button" id="btnAddCert">Adicionar</button>
              <button class="btn" type="button" id="btnManageCerts">Gerenciar lista</button>
            </div>
          </div>

          <div id="certManage" class="card" style="margin-top:14px;display:none">
            <div class="hd"><div class="muted">Lista de certificações (clique para remover)</div></div>
            <div class="bd" id="certManageList"></div>
          </div>

          <div class="sep"></div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <button class="btn primary" type="button" id="btnSave">Salvar</button>
            <button class="btn" type="button" id="btnCancel">Cancelar</button>
            <span class="note" id="formMsg"></span>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- IMPORTANTÍSSIMO: app.js precisa existir com esse nome exato (minúsculo) -->
<script src="./app.js?v=3"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const warn = (text) => {
    const el = document.getElementById("jsWarn");
    el.style.display = "block";
    el.textContent = text;
  };

  if (!window.App) {
    warn("Erro: app.js não carregou. Confira se o arquivo se chama 'app.js' (minúsculo) e se o caminho está './app.js'.");
    console.error("window.App indefinido -> app.js não carregou.");
    return;
  }

  const A = window.App;
  const $ = (id) => document.getElementById(id);

  // Guardas (se tiver, ótimo; se não tiver, não quebra)
  if (A.renderKpis) A.renderKpis();
  if (A.wireResetButton) A.wireResetButton();

  // Chaves
  const TH_KEY   = A.TH_KEY;
  const CERT_KEY = A.CERT_KEY;
  const UNIT_KEY = A.UNIT_KEY;

  const loadJSON = A.loadJSON;
  const saveJSON = A.saveJSON;
  const uid = A.uid;
  const nowISO = A.nowISO;
  const escapeHtml = A.escapeHtml;
  const onlyDigits = A.onlyDigits;

  // Defaults
  function ensureDefaults(){
    const certs = loadJSON(CERT_KEY, null);
    if (!Array.isArray(certs) || !certs.length){
      saveJSON(CERT_KEY, [
        "Massagem Nuru",
        "Massagem Vivência",
        "Podolatria",
        "Massagem Casais",
        "Massagem Feminina"
      ]);
    }
    const units = loadJSON(UNIT_KEY, null);
    if (!Array.isArray(units) || !units.length){
      saveJSON(UNIT_KEY, ["Unidade 1", "Unidade 2"]);
    }
  }
  ensureDefaults();

  function showList(){
    $("viewForm").style.display = "none";
    $("viewList").style.display = "block";
    $("formMsg").textContent = "";
    renderList();
  }
  function showForm(){
    $("viewList").style.display = "none";
    $("viewForm").style.display = "block";
  }

  function getStatusValue(){
    const el = document.querySelector('input[name="status"]:checked');
    return el ? el.value : "Ativo";
  }
  function setStatusValue(v){
    document.querySelectorAll('input[name="status"]').forEach(n => n.checked = (n.value === v));
  }

  function renderUnits(){
    const units = loadJSON(UNIT_KEY, []);
    $("unit").innerHTML = units.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join("");
  }

  function renderCerts(){
    const certs = loadJSON(CERT_KEY, []);
    $("certBox").innerHTML = certs.map(c => `
      <label style="display:flex;gap:8px;align-items:center;color:var(--muted);border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);padding:8px 10px;border-radius:14px;">
        <input type="checkbox" value="${escapeHtml(c)}"> ${escapeHtml(c)}
      </label>
    `).join("");
  }

  function selectedCerts(){
    return Array.from(document.querySelectorAll("#certBox input[type=checkbox]:checked")).map(x => x.value);
  }
  function applySelectedCerts(arr){
    const set = new Set(arr || []);
    document.querySelectorAll("#certBox input[type=checkbox]").forEach(cb => cb.checked = set.has(cb.value));
  }

  function clearForm(){
    $("th_id").value = "";
    $("fullName").value = "";
    $("profName").value = "";
    $("birthDate").value = "";
    $("cpf").value = "";
    $("email").value = "";
    $("address").value = "";
    $("contact").value = "";
    $("emergency").value = "";
    $("pixType").value = "CPF";
    $("pixKey").value = "";
    $("hasOff").value = "Sim";
    $("offDay").value = "";
    $("startTime").value = "";
    $("endTime").value = "";
    $("startDate").value = "";
    $("bloodType").value = "";
    setStatusValue("Ativo");
    applySelectedCerts([]);
  }

  function validateForm(){
    const errs = [];
    const fullName = $("fullName").value.trim();
    const profName = $("profName").value.trim();
    const birthDate = $("birthDate").value;
    const cpf = onlyDigits($("cpf").value);
    const email = $("email").value.trim();
    const unit = $("unit").value;
    const contact = $("contact").value.trim();
    const startTime = $("startTime").value;
    const endTime = $("endTime").value;
    const startDate = $("startDate").value;
    const hasOff = $("hasOff").value === "Sim";
    const offDay = $("offDay").value;

    if (!fullName) errs.push("Nome Completo");
    if (!profName) errs.push("Nome profissional");
    if (!birthDate) errs.push("Data de Nascimento");
    if (!cpf || cpf.length !== 11) errs.push("CPF (11 dígitos)");
    if (!email) errs.push("Email");
    if (!unit) errs.push("Unidade");
    if (!contact) errs.push("Contato");
    if (!startTime) errs.push("Horário de Entrada");
    if (!endTime) errs.push("Horário de Saída");
    if (!startDate) errs.push("Data de Início");
    if (hasOff && !offDay) errs.push("Dia da Folga");

    return { ok: errs.length === 0, errs };
  }

  function saveTherapist(){
    const msg = $("formMsg");
    msg.textContent = "";

    const v = validateForm();
    if (!v.ok){
      msg.textContent = "Preencha: " + v.errs.join(", ") + ".";
      msg.style.color = "var(--bad)";
      return;
    }

    const id = $("th_id").value || uid();
    const items = loadJSON(TH_KEY, []);
    const idx = items.findIndex(x => x.id === id);

    const record = {
      id,
      fullName: $("fullName").value.trim(),
      profName: $("profName").value.trim(),
      birthDate: $("birthDate").value,
      cpf: onlyDigits($("cpf").value),
      email: $("email").value.trim(),
      unit: $("unit").value,
      address: $("address").value.trim(),
      contact: $("contact").value.trim(),
      emergency: $("emergency").value.trim(),
      pixType: $("pixType").value,
      pixKey: $("pixKey").value.trim(),
      hasOff: $("hasOff").value === "Sim",
      offDay: $("offDay").value,
      startTime: $("startTime").value,
      endTime: $("endTime").value,
      startDate: $("startDate").value,
      bloodType: $("bloodType").value,
      status: getStatusValue(),
      certs: selectedCerts(),
      updated_at: nowISO(),
      created_at: (idx >= 0 ? items[idx].created_at : nowISO())
    };

    if (idx >= 0) items[idx] = record;
    else items.unshift(record);

    saveJSON(TH_KEY, items);
    showList();
  }

  function loadForm(id){
    const items = loadJSON(TH_KEY, []);
    const t = items.find(x => x.id === id);
    if (!t) return;

    $("th_id").value = t.id;
    $("fullName").value = t.fullName || "";
    $("profName").value = t.profName || "";
    $("birthDate").value = t.birthDate || "";
    $("cpf").value = t.cpf || "";
    $("email").value = t.email || "";
    $("address").value = t.address || "";
    $("contact").value = t.contact || "";
    $("emergency").value = t.emergency || "";
    $("pixType").value = t.pixType || "CPF";
    $("pixKey").value = t.pixKey || "";
    $("hasOff").value = t.hasOff ? "Sim" : "Não";
    $("offDay").value = t.offDay || "";
    $("startTime").value = t.startTime || "";
    $("endTime").value = t.endTime || "";
    $("startDate").value = t.startDate || "";
    $("bloodType").value = t.bloodType || "";
    setStatusValue(t.status || "Ativo");
    $("unit").value = t.unit || "";
    applySelectedCerts(t.certs || []);
  }

  function deleteTherapist(id){
    if (!confirm("Excluir este cadastro?")) return;
    const items = loadJSON(TH_KEY, []);
    saveJSON(TH_KEY, items.filter(x => x.id !== id));
    renderList();
  }

  function renderList(){
    const tbody = $("th_rows");
    const empty = $("th_empty");
    const filter = $("th_filter").value;
    const q = $("th_q").value.trim().toLowerCase();

    const items = loadJSON(TH_KEY, []).filter(t => {
      const ok = (filter === "ALL") || (t.status === filter);
      const hay = (t.fullName+" "+t.profName+" "+t.unit+" "+t.cpf+" "+t.email).toLowerCase();
      return ok && (!q || hay.includes(q));
    });

    tbody.innerHTML = "";
    if (!items.length){
      empty.textContent = "Nenhuma terapeuta cadastrada.";
      return;
    }
    empty.textContent = "";

    for (const t of items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="font-weight:750">${escapeHtml(t.profName || t.fullName || "")}</div>
          <div class="muted" style="margin-top:6px">
            ${escapeHtml(t.fullName||"")} • ${escapeHtml(t.unit||"")} • ${escapeHtml(t.status||"")}
          </div>
          <div class="muted" style="margin-top:6px">
            CPF: ${escapeHtml(t.cpf||"")} • ${escapeHtml(t.email||"")}
          </div>
        </td>
        <td class="td-actions">
          <button class="btn small" type="button" data-edit="${t.id}">Editar</button>
          <button class="btn danger small" type="button" data-del="${t.id}">Excluir</button>
        </td>
      `;

      tr.querySelector("[data-edit]").addEventListener("click", () => {
        $("formTitle").textContent = "Editar Terapeuta";
        renderUnits(); renderCerts();
        loadForm(t.id);
        showForm();
      });
      tr.querySelector("[data-del]").addEventListener("click", () => deleteTherapist(t.id));
      tbody.appendChild(tr);
    }
  }

  // Wire eventos
  $("btnNew").addEventListener("click", () => {
    $("formTitle").textContent = "Nova Terapeuta";
    renderUnits();
    renderCerts();
    clearForm();
    showForm();
  });

  $("btnCancel").addEventListener("click", showList);
  $("btnSave").addEventListener("click", saveTherapist);

  $("th_filter").addEventListener("change", renderList);
  $("th_q").addEventListener("input", renderList);

  $("btnAddUnit").addEventListener("click", () => {
    const u = $("unitNew").value.trim();
    if (!u) return;
    const units = loadJSON(UNIT_KEY, []);
    if (!units.includes(u)) units.push(u);
    saveJSON(UNIT_KEY, units);
    $("unitNew").value = "";
    renderUnits();
    $("unit").value = u;
  });

  $("btnAddCert").addEventListener("click", () => {
    const c = $("certNew").value.trim();
    if (!c) return;
    const certs = loadJSON(CERT_KEY, []);
    if (!certs.includes(c)) certs.push(c);
    saveJSON(CERT_KEY, certs);
    $("certNew").value = "";
    renderCerts();
  });

  $("btnManageCerts").addEventListener("click", () => {
    const box = $("certManage");
    box.style.display = (box.style.display === "none" ? "block" : "none");
    renderCertManage();
  });

  function renderCertManage(){
    const certs = loadJSON(CERT_KEY, []);
    const wrap = $("certManageList");
    if (!certs.length){
      wrap.innerHTML = `<div class="note">Sem certificações.</div>`;
      return;
    }
    wrap.innerHTML = certs.map(c => `
      <button class="btn small" type="button" data-cert="${escapeHtml(c)}" style="margin:6px 6px 0 0">
        Remover: ${escapeHtml(c)}
      </button>
    `).join("");

    wrap.querySelectorAll("button[data-cert]").forEach(btn => {
      btn.addEventListener("click", () => {
        const cert = btn.getAttribute("data-cert");
        const next = loadJSON(CERT_KEY, []).filter(x => x !== cert);
        saveJSON(CERT_KEY, next);
        renderCerts();
        renderCertManage();
      });
    });
  }

  // Init
  renderUnits();
  renderCerts();
  renderList();
});
</script>
</body>
</html>
