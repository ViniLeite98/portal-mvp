<script>
/* ===============================
   LOAD STORAGE
================================ */
const terapeutas =
  JSON.parse(localStorage.getItem("terapeutas")) || [];
const solicitacoes =
  JSON.parse(localStorage.getItem("solicitacoes")) || [];

/* ===============================
   HELPERS
================================ */
function horaParaNumero(h) {
  if (!h || !h.includes(":")) return null;
  const [hh, mm] = h.split(":").map(Number);
  if (isNaN(hh) || isNaN(mm)) return null;
  return hh + mm / 60;
}

/* ===============================
   EQUIPE ATIVA
================================ */
const ativas = terapeutas.filter(t =>
  (!t.status || t.status === "Ativo")
);

document.getElementById("kpiEquipe").innerText = ativas.length;

/* ===============================
   DIAS FOLGADOS
================================ */
const diasPorPessoa = {};

solicitacoes
  .filter(s => s.status === "Aprovado")
  .forEach(s => {
    if (!s.dtInicio || !s.dtFim) return;

    const ini = new Date(s.dtInicio);
    const fim = new Date(s.dtFim);
    if (isNaN(ini) || isNaN(fim)) return;

    const dias =
      Math.floor((fim - ini) / 86400000) + 1;
    if (dias <= 0) return;

    const nome = s.terapeutaNome || "—";
    diasPorPessoa[nome] =
      (diasPorPessoa[nome] || 0) + dias;
  });

const folgaDiv = document.getElementById("diasFolga");
const rankingFolga = Object.entries(diasPorPessoa)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5);

folgaDiv.innerHTML =
  rankingFolga.length === 0
    ? "—"
    : rankingFolga
        .map(([n, d]) => `<div><b>${n}</b>: ${d} dias</div>`)
        .join("");

/* ===============================
   FORÇA DE TRABALHO
================================ */
const horas = Array.from({ length: 14 }, (_, i) => i + 9);

const contagem = horas.map(hora => {
  return ativas.filter(t => {
    const ini = horaParaNumero(t.horaEntrada);
    const fim = horaParaNumero(t.horaSaida);
    if (ini === null || fim === null) return false;
    return hora >= ini && hora < fim;
  }).length;
});

const ctx = document.getElementById("grafico");
if (ctx) {
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: horas.map(h => `${h}:00`),
      datasets: [{
        label: "Terapeutas ativas",
        data: contagem,
        backgroundColor: "#3b82f6"
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}

/* ===============================
   CARGA HORÁRIA
================================ */
const carga = {};

ativas.forEach(t => {
  const ini = horaParaNumero(t.horaEntrada);
  const fim = horaParaNumero(t.horaSaida);
  if (ini === null || fim === null || fim <= ini) return;

  const horasTrab = fim - ini;
  const nome = t.nomeProfissional || t.nomeCompleto || "—";

  carga[nome] = (carga[nome] || 0) + horasTrab;
});

const rankDiv = document.getElementById("rankHoras");
rankDiv.innerHTML = "";

Object.entries(carga)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5)
  .forEach(([nome, h]) => {
    rankDiv.innerHTML += `<div>${nome}: ${h.toFixed(1)}h</div>`;
  });
</script>
